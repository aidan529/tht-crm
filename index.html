<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Headline Theory ‚Äî CRM</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%237c3aed'/%3E%3Cstop offset='1' stop-color='%234f46e5'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='7' fill='url(%23g)'/%3E%3Ctext x='16' y='22.5' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='17' fill='white'%3ET%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%237c3aed'/%3E%3Ctext x='90' y='125' text-anchor='middle' font-family='system-ui' font-weight='800' font-size='100' fill='white'%3ET%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f6f5ff;
  --nav: #1e1b3a;
  --purple: #7c3aed;
  --purple-light: #ede9fe;
  --purple-mid: #a78bfa;
  --text: #111827;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --border: #e5e7eb;
  --card: #ffffff;
  --col-bg: #f9fafb;
  --green: #22c55e;
  --yellow: #eab308;
  --red: #ef4444;
  --radius: 8px;
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

/* Top Nav */
.topbar { background: var(--nav); height: 52px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: sticky; top: 0; z-index: 100; }
.topbar-brand { font-weight: 800; font-size: 15px; color: #fff; letter-spacing: -.3px; }
.topbar-tabs { display: flex; gap: 2px; margin-left: 18px; }
.topbar-tab { padding: 6px 14px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; background: transparent; color: #a5b4fc; font-family: var(--font); transition: all .15s; }
.topbar-tab.active { background: var(--purple); color: #fff; }
.topbar-tab:hover:not(.active) { background: rgba(124,58,237,.25); }
.topbar-right { display: flex; align-items: center; gap: 10px; }
.topbar-stat { font-size: 11px; color: #a5b4fc; }
.btn { padding: 5px 12px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; font-family: var(--font); transition: all .12s; }
.btn-ghost { background: #312e81; color: #c4b5fd; }
.btn-ghost:hover { background: #3b3794; }
.btn-primary { background: var(--purple); color: #fff; font-weight: 700; }
.btn-primary:hover { background: #6d28d9; }
.btn-danger { background: #fef2f2; color: var(--red); border: 1px solid #fecaca; }

/* Board */
.board { display: flex; gap: 10px; padding: 16px 14px 24px; overflow-x: auto; min-height: calc(100vh - 52px); align-items: flex-start; }
.column { min-width: 230px; max-width: 270px; flex: 1 1 230px; display: flex; flex-direction: column; }
.col-header { padding: 10px 12px; background: var(--card); border-radius: var(--radius) var(--radius) 0 0; border-top: 3px solid var(--purple); display: flex; justify-content: space-between; align-items: flex-start; transition: background .15s; }
.col-header.drag-over { background: var(--purple-light); }
.col-title { font-weight: 700; font-size: 12px; color: var(--text); margin-bottom: 2px; }
.col-meta { font-size: 10.5px; color: var(--text-muted); }
.col-body { flex: 1; background: var(--col-bg); padding: 6px; border-radius: 0 0 var(--radius) var(--radius); min-height: 110px; transition: background .15s; }
.col-body.drag-over { background: #f5f3ff; }
.col-empty { padding: 28px 0; text-align: center; font-size: 11px; color: #d1d5db; font-style: italic; }

/* Deal Card */
.deal-card { background: var(--card); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 6px; border: 1px solid var(--border); cursor: pointer; transition: box-shadow .15s, transform .1s; position: relative; z-index: 1; }
.deal-card.badge-open { z-index: 100; }
.deal-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.1); transform: translateY(-1px); }
.deal-card.dragging { opacity: .5; }
.delete-zone { display:none; position:fixed; bottom:0; left:0; right:0; height:64px; z-index:999; transition:all .15s; }
.delete-zone.visible { display:flex; }
.delete-zone-half { flex:1; display:flex; justify-content:center; align-items:center; gap:8px; font-weight:700; font-size:14px; transition:all .15s; cursor:default; }
.delete-zone-lost { background:linear-gradient(to bottom, #fecaca, #ef4444); color:#fff; border-top:2px solid #dc2626; }
.delete-zone-lost.drag-hover { background:linear-gradient(to bottom, #f87171, #b91c1c); height:80px; font-size:16px; }
.delete-zone-won { background:linear-gradient(to bottom, #bbf7d0, #22c55e); color:#fff; border-top:2px solid #16a34a; }
.delete-zone-won.drag-hover { background:linear-gradient(to bottom, #4ade80, #15803d); height:80px; font-size:16px; }
.deal-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
.deal-reply-snippet { font-size: 10px; color: #6b7280; background: #f0fdf4; border-radius: 4px; padding: 3px 6px; margin-top: 4px; line-height: 1.3; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; border-left: 2px solid #86efac; }
.deal-company { font-weight: 700; font-size: 12.5px; color: var(--text); line-height: 1.3; flex: 1; margin-right: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.deal-contact { font-size: 11px; color: var(--text-secondary); margin-bottom: 2px; }
.deal-detail { font-size: 10.5px; color: var(--text-muted); margin-bottom: 1px; }
.deal-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
.deal-value { font-size: 12px; font-weight: 700; }
.deal-tag { font-size: 9.5px; padding: 1px 6px; border-radius: 8px; background: #f3f4f6; color: var(--text-secondary); }
.book-discovery-btn { display:block;text-align:center;background:#2563eb;color:#fff;font-size:11px;font-weight:600;padding:5px 8px;border-radius:6px;text-decoration:none;margin:6px 0 2px; }
.book-discovery-btn:hover { background:#1d4ed8; }

/* Flag dot */
.status-indicator { display: flex; align-items: center; gap: 4px; cursor: pointer; position: relative; }
.status-indicator:hover .status-dot { transform: scale(1.15); }
.status-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; transition: all .12s; border: 2px solid rgba(255,255,255,.8); box-shadow: 0 1px 3px rgba(0,0,0,.15); }
.status-count { font-size: 13px; font-weight: 800; line-height: 1; }

/* Activity Badge */
.search-input { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); border-radius: 8px; color: #fff; padding: 6px 28px 6px 10px; font-size: 13px; font-family: inherit; width: 200px; outline: none; transition: all .2s; }
.search-input::placeholder { color: rgba(255,255,255,.45); }
.search-input:focus { background: rgba(255,255,255,.15); border-color: rgba(255,255,255,.4); width: 260px; }
.search-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,.5); cursor: pointer; font-size: 16px; line-height: 1; }
.search-clear:hover { color: #fff; }
.search-wrapper { position: relative; }
.search-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; width: 420px; max-height: 400px; overflow-y: auto; background: #fff; border-radius: 10px; box-shadow: 0 12px 36px rgba(0,0,0,.2); z-index: 100; border: 1px solid #e5e7eb; }
.search-result-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background .1s; }
.search-result-item:hover { background: #f0f4ff; }
.search-result-item:last-child { border-bottom: none; }
.search-result-main { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.search-result-name { font-weight: 600; font-size: 13px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 260px; }
.search-result-stage { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f3f4f6; color: #6b7280; white-space: nowrap; }
.search-result-meta { display: flex; gap: 10px; margin-top: 3px; font-size: 11px; color: #9ca3af; flex-wrap: wrap; }
.search-empty { padding: 20px; text-align: center; color: #9ca3af; font-size: 13px; }
.imessage-btn { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; font-size: 11px; font-weight: 600; color: #2563eb; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; text-decoration: none; cursor: pointer; transition: all .15s; white-space: nowrap; }
.imessage-btn:hover { background: #dbeafe; border-color: #93c5fd; }

.activity-badge-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
.badge-dropdown { position: absolute; top: calc(100% + 4px); right: 0; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 8px 24px rgba(0,0,0,.12); padding: 8px; min-width: 210px; z-index: 999; max-height: 220px; overflow-y: auto; }
.badge-dropdown-title { font-size: 10px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; padding: 0 4px; }
.badge-item { display: flex; align-items: center; gap: 6px; padding: 5px 4px; border-bottom: 1px solid #f3f4f6; font-size: 11.5px; }
.badge-item:last-child { border-bottom: none; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(2px); }
.modal { background: var(--card); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,.2); max-height: 90vh; overflow-y: auto; }
.modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-header h3 { font-size: 16px; font-weight: 800; }
.modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text-muted); line-height: 1; }
.modal-body { padding: 20px; }
.modal-footer { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.form-group label { font-size: 11px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 3px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12.5px; font-family: var(--font); outline: none; transition: border-color .15s; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--purple); }
.form-group textarea { resize: vertical; }
.form-span2 { grid-column: span 2; }

/* Smartlead info box */
.sl-info { background: #faf5ff; border: 1px solid #e9d5ff; border-radius: var(--radius); padding: 8px 12px; margin-bottom: 16px; font-size: 11px; }
.sl-info-title { font-weight: 700; color: var(--purple); margin-bottom: 4px; }
.sl-info div { color: var(--text-secondary); }
.sl-info a { color: var(--purple); font-size: 10.5px; }
.reply-preview { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:var(--radius); padding:10px 12px; margin-bottom:16px; font-size:12px; }
.reply-preview-title { font-weight:700; color:#15803d; margin-bottom:6px; font-size:11px; display:flex; align-items:center; gap:5px; }
.reply-preview-body { color:#374151; white-space:pre-wrap; word-break:break-word; max-height:120px; overflow-y:auto; line-height:1.5; }
.reply-preview-category { display:inline-block; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; margin-left:6px; }
.cat-interested { background:#dcfce7; color:#166534; }
.cat-meeting { background:#dbeafe; color:#1e40af; }
.cat-info { background:#fef3c7; color:#92400e; }
.forward-btn { width:100%; justify-content:center; gap:6px; font-size:13px; padding:10px; font-weight:700; }
.forward-btn.sent { background:#f0fdf4; border-color:#bbf7d0; color:#15803d; cursor:default; }
.forward-btn.ready { background:#2563eb; border-color:#2563eb; color:#fff; }
.forward-btn.ready:hover { background:#1d4ed8; }

/* Activities */
.activities-section { border-top: 1px solid var(--border); padding-top: 14px; margin-top: 8px; }
.activities-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.activities-header h4 { font-size: 13px; font-weight: 700; }
.sop-btn { font-size: 11px; padding: 4px 10px; border-radius: 6px; border: 1px solid var(--purple); cursor: pointer; font-weight: 600; font-family: var(--font); transition: all .15s; }
.sop-btn.active { background: var(--purple); color: #fff; }
.sop-btn:not(.active) { background: #fff; color: var(--purple); }
.sop-grid { background: #faf5ff; border-radius: var(--radius); padding: 10px; margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 6px; }
.sop-day-btn { font-size: 11px; padding: 5px 10px; border-radius: 6px; border: 1px solid #d8b4fe; background: #fff; color: var(--purple); cursor: pointer; font-weight: 600; font-family: var(--font); }
.sop-day-btn:hover { background: var(--purple-light); }
.add-act-row { display: flex; gap: 6px; margin-bottom: 12px; align-items: flex-end; }
.add-act-row select, .add-act-row input { padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 11.5px; font-family: var(--font); }
.act-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; margin-bottom: 3px; border-radius: 6px; border: 1px solid; }
.act-item.overdue { background: #fef2f2; border-color: #fecaca; }
.act-item.today { background: #f0fdf4; border-color: #bbf7d0; }
.act-item.future { background: var(--col-bg); border-color: #f3f4f6; }
.act-item input[type="checkbox"] { accent-color: var(--purple); cursor: pointer; }
.act-subject { flex: 1; font-size: 11.5px; color: #374151; }
.act-day-label { font-size: 10px; color: var(--text-muted); background: #f3f4f6; padding: 1px 6px; border-radius: 8px; }
.act-delete { background: none; border: none; color: #d1d5db; cursor: pointer; font-size: 14px; }
.completed-toggle { font-size: 11px; color: var(--text-muted); cursor: pointer; margin-top: 8px; margin-bottom: 4px; }
.completed-item { display: flex; align-items: center; gap: 8px; padding: 4px 8px; margin-bottom: 2px; opacity: .5; }
.completed-item .act-subject { text-decoration: line-through; color: var(--text-muted); }
.no-activities { font-size: 11.5px; color: #d1d5db; text-align: center; padding: 12px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }

/* Settings Panel */
.settings-overlay { position:fixed; inset:0; background:rgba(0,0,0,.3); z-index:10000; opacity:0; transition:opacity .2s; }
.settings-overlay.open { opacity:1; }
.settings-panel { position:fixed; top:0; right:-480px; width:460px; max-width:90vw; height:100vh; background:#fff; box-shadow:-4px 0 24px rgba(0,0,0,.15); z-index:10001; transition:right .25s ease; display:flex; flex-direction:column; }
.settings-panel.open { right:0; }
.settings-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
.settings-header h3 { font-size:16px; font-weight:800; display:flex; align-items:center; gap:8px; }
.settings-body { flex:1; overflow-y:auto; padding:16px 20px; }
.settings-section { margin-bottom:24px; }
.settings-section h4 { font-size:13px; font-weight:700; color:var(--purple); margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.settings-list { list-style:none; }
.settings-list-item { display:flex; align-items:center; gap:8px; padding:7px 8px; margin-bottom:4px; background:#f9fafb; border:1px solid var(--border); border-radius:6px; font-size:12px; cursor:grab; }
.settings-list-item:active { cursor:grabbing; }
.settings-list-item.dragging { opacity:.4; }
.settings-list-item .drag-handle { color:#d1d5db; font-size:14px; cursor:grab; flex-shrink:0; }
.settings-list-item .item-label { flex:1; font-weight:500; }
.settings-list-item .item-color { width:14px; height:14px; border-radius:50%; border:2px solid rgba(0,0,0,.1); flex-shrink:0; cursor:pointer; }
.settings-list-item .item-delete { background:none; border:none; color:#d1d5db; cursor:pointer; font-size:14px; padding:0 2px; }
.settings-list-item .item-delete:hover { color:#ef4444; }
.settings-add-row { display:flex; gap:6px; margin-top:6px; }
.settings-add-row input { flex:1; padding:6px 8px; border:1px solid var(--border); border-radius:6px; font-size:12px; font-family:var(--font); }
.settings-add-row button { padding:6px 12px; font-size:11px; }
.settings-footer { padding:12px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; flex-shrink:0; }
.sop-sequence { background:#faf5ff; border:1px solid #e9d5ff; border-radius:6px; padding:8px 10px; margin-bottom:8px; }
.sop-sequence-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.sop-sequence-header span { font-size:12px; font-weight:700; color:var(--purple); }
.sop-act-item { display:flex; align-items:center; gap:6px; padding:3px 0; font-size:11.5px; }
.sop-act-item select { padding:3px 6px; border:1px solid #d8b4fe; border-radius:4px; font-size:11px; font-family:var(--font); }
.sop-act-item input { flex:1; padding:3px 6px; border:1px solid #d8b4fe; border-radius:4px; font-size:11px; font-family:var(--font); }
.settings-tab-bar { display:flex; border-bottom:1px solid var(--border); padding:0 20px; flex-shrink:0; }
.settings-tab { padding:8px 14px; font-size:12px; font-weight:600; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; font-family:var(--font); background:none; border-top:none; border-left:none; border-right:none; }
.settings-tab.active { color:var(--purple); border-bottom-color:var(--purple); }
/* Login Screen */
.login-wrapper { min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); padding:20px; }
.login-box { width:360px; max-width:100%; }
.login-logo { text-align:center; margin-bottom:32px; }
.login-logo-icon { width:56px; height:56px; border-radius:14px; background:linear-gradient(135deg,#7c3aed,#4f46e5); display:inline-flex; align-items:center; justify-content:center; margin-bottom:16px; box-shadow:0 8px 24px rgba(124,58,237,.3); }
.login-logo-icon span { font-size:28px; font-weight:900; color:#fff; }
.login-logo h1 { font-size:20px; font-weight:800; color:var(--text); letter-spacing:-.5px; }
.login-logo p { font-size:13px; color:var(--text-secondary); margin-top:4px; }
.login-form { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; }
.login-field { margin-bottom:16px; }
.login-field label { font-size:12px; font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; }
.login-field input { width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:8px; font-size:14px; font-family:var(--font); background:var(--bg); color:var(--text); outline:none; transition:border-color .15s; }
.login-field input:focus { border-color:var(--purple); box-shadow:0 0 0 3px rgba(124,58,237,.1); }
.login-btn { width:100%; padding:11px; border-radius:8px; border:none; background:var(--purple); color:#fff; font-size:14px; font-weight:700; font-family:var(--font); cursor:pointer; transition:all .15s; }
.login-btn:hover { background:#6d28d9; }
.login-btn:disabled { opacity:.6; cursor:not-allowed; }
.login-error { color:var(--red); font-size:12px; text-align:center; margin-top:12px; display:none; }
</style>
</head>
<body>

<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH ‚Äî Firebase login (DISABLED ‚Äî will enable once Firebase project is configured)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = { name: 'Aidan', email: 'aidanhutch7@gmail.com' };

function logout(){ location.reload(); }
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THT CRM ‚Äî The Headline Theory Deal Pipeline
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGE THIS to your deployed Apps Script URL:
const API_URL = "https://script.google.com/macros/s/AKfycbyI_o-TL-aiKfQEMU5W5OsBadp0QMJkgZyY-RDr4dY19Wv944yxXVfgnlzxetL7-hh-/exec";
const SYNC_INTERVAL = 30000;
const deletedDealIds = new Set();
const deletedActivityIds = new Set();
let pendingWrites = 0; // Prevent sync from overwriting during active writes
let savedScrollLeft = 0; // Preserve horizontal scroll across renders
let settingsOpen = false;
let settingsTab = 'stages'; // stages | activities | sop | clients
let clientsSubTab = 'notifications'; // notifications | calendly
let settingsDraft = null; // Working copy of settings being edited

// ‚îÄ‚îÄ‚îÄ Configs ‚îÄ‚îÄ‚îÄ
const ACQUISITION_STAGES = [
  { id: "Cold Email Response", label: "Cold Email Response", color: "#7c3aed" },
  { id: "Follow-up", label: "Follow-up", color: "#6366f1" },
  { id: "Discovery Scheduled", label: "Discovery Scheduled", color: "#2563eb" },
  { id: "Demo Scheduled", label: "Demo Scheduled", color: "#0891b2" },
  { id: "No Show", label: "No Show", color: "#ef4444" },
  { id: "Waiting for Payment/Contract", label: "Waiting for Payment/Contract", color: "#d97706" },
  { id: "Closed Won", label: "Closed Won", color: "#10b981" },
  { id: "Closed Lost", label: "Closed Lost", color: "#64748b" },
];

const NURTURE_STAGES = [
  { id: "Revisit", label: "Revisit", color: "#8b5cf6" },
  { id: "Service Area Taken", label: "Service Area Taken", color: "#f97316" },
];

const PIPELINES = [
  { id: "acquisition", label: "Acquisition" },
  { id: "client_leads", label: "Client Leads" },
  { id: "nurture", label: "Long Term Nurture" },
];

const ACTIVITY_TYPES = ["Call", "Text", "Email", "Discovery Call", "Demo", "Follow-up", "Meeting", "Task"];
const ACTIVITY_ICONS = { Call: "üìû", Text: "üí¨", Email: "‚úâÔ∏è", "Discovery Call": "üîç", Demo: "üñ•Ô∏è", "Follow-up": "‚Ü©Ô∏è", Meeting: "üìÖ", Task: "‚úì" };
const FLAG_COLORS = { green: "#22c55e", yellow: "#eab308", red: "#ef4444", none: "transparent" };
const FLAG_CYCLE = ["none", "green", "yellow", "red"];
const CLIENT_PALETTE = ["#2563eb","#7c3aed","#0891b2","#059669","#d97706","#dc2626","#6366f1","#0d9488","#b45309","#4f46e5","#be185d","#15803d"];

// Default Calendly links for known clients (applied on sync if not already set)
const DEFAULT_CALENDLY_URLS = {
  "High Southern Landscapes": "https://calendly.com/will-highsouthernscapes/30min",
  "High Southern": "https://calendly.com/will-highsouthernscapes/30min",
  "Time Savers Landscaping": "https://calendly.com/timesaverslandscaping/meeting-with-time-savers",
  "Time Savers": "https://calendly.com/timesaverslandscaping/meeting-with-time-savers",
  "Coastal Lawn Care": "https://calendly.com/ryan-coastallawncare/meeting-with-coastal-lawn-care",
  "Lightning Lawn Care": "https://calendly.com/jonrebel3/quote-meeting-with-lightning-lawn-care",
};

const SOP_DAYS = {
  "Day 1": [{type:"Text",subject:"Initial text - immediate"},{type:"Call",subject:"Call #1 - immediate"},{type:"Text",subject:"Post-call text"},{type:"Email",subject:"Initial email"},{type:"Call",subject:"Call #2 - EOD"}],
  "Day 2": [{type:"Call",subject:"Morning call"},{type:"Text",subject:"Follow-up text"},{type:"Email",subject:"Follow-up email"},{type:"Call",subject:"Evening call"}],
  "Day 3": [{type:"Call",subject:"Morning call"},{type:"Text",subject:"Follow-up text"},{type:"Email",subject:"Follow-up email"},{type:"Call",subject:"Evening call"}],
  "Day 4": [{type:"Call",subject:"Morning call"},{type:"Email",subject:"Follow-up email"},{type:"Call",subject:"Evening call"}],
  "Day 5": [{type:"Email",subject:"Follow-up email"}],
  "Day 6": [{type:"Email",subject:"Follow-up email"},{type:"Call",subject:"Check-in call"}],
  "Day 8": [{type:"Email",subject:"Follow-up email"}],
  "Day 9": [{type:"Call",subject:"Check-in call"}],
  "Day 10": [{type:"Email",subject:"Final email"}],
  "Day 30": [{type:"Email",subject:"Last attempt email"},{type:"Call",subject:"Last attempt call"}],
};

const CLIENT_SOP_DAYS = {
  "Call + Email": [{type:"Call",subject:"Follow-up call"},{type:"Email",subject:"Follow-up email"}],
};
function getSopDays(deal){
  return (deal && deal.pipeline==='Client') ? CLIENT_SOP_DAYS : SOP_DAYS;
}

// ‚îÄ‚îÄ‚îÄ Test Data ‚îÄ‚îÄ‚îÄ
function getToday(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function TODAY(){ return getToday(); }
const YESTERDAY = new Date(Date.now()-86400000).toISOString().split("T")[0];
const TOMORROW = new Date(Date.now()+86400000).toISOString().split("T")[0];

const TEST_DEALS = [
  {id:"t1",company:"Southern Cutz Lawn & Landscape",contact:"Marcus Johnson",email:"marcus@southerncutz.com",phone:"(321) 555-0142",value:1057,stage:"Cold Email Response",pipeline:"Client",flag:"green",notes:"",website:"southerncutz.com",location:"Brevard, FL",campaignName:"FL Landscaping",leadCategory:"Interested",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:TODAY(),lastUpdated:TODAY()},
  {id:"t2",company:"Hill's Lawn & Grounds Care",contact:"David Hill",email:"info@hillslawn.com",phone:"(303) 555-0198",value:1057,stage:"Follow-up",pipeline:"Client",flag:"green",notes:"",website:"hillslawn.com",location:"Denver, CO",campaignName:"CO Landscaping",leadCategory:"Information Request",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:YESTERDAY,lastUpdated:TODAY()},
  {id:"t3",company:"Denver Landscaping & Design",contact:"Sarah Chen",email:"sarah@denverld.com",phone:"",value:1057,stage:"Follow-up",pipeline:"Client",flag:"",notes:"Waiting on callback",website:"denverld.com",location:"Denver, CO",campaignName:"CO Landscaping",leadCategory:"Interested",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:YESTERDAY,lastUpdated:TODAY()},
  {id:"t4",company:"All Proscape LLC",contact:"Tony Rivera",email:"tony@allproscape.com",phone:"(512) 555-0167",value:1057,stage:"Discovery Scheduled",pipeline:"Acquisition",flag:"red",notes:"Missed last call",website:"allproscape.com",location:"Austin, TX",campaignName:"TX Acquisition",leadCategory:"Meeting Request",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:YESTERDAY,lastUpdated:TODAY()},
  {id:"t5",company:"Prestonwood Landscape Services",contact:"Mike Preston",email:"mike@prestonwood.com",phone:"(214) 555-0233",value:0,stage:"Demo Scheduled",pipeline:"Client",flag:"red",notes:"",website:"prestonwood.com",location:"Dallas, TX",campaignName:"TX Landscaping",leadCategory:"Meeting Booked",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:YESTERDAY,lastUpdated:TODAY()},
  {id:"t6",company:"Sapphire Property Maintenance",contact:"Jade Williams",email:"jade@sapphirepm.com",phone:"",value:1057,stage:"Waiting for Payment/Contract",pipeline:"Client",flag:"green",notes:"Contract sent 2/7",website:"sapphirepm.com",location:"Houston, TX",campaignName:"TX Landscaping",leadCategory:"Interested",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:"2025-02-05",lastUpdated:TODAY()},
  {id:"t7",company:"GreenEdge Landscaping",contact:"Pat O'Brien",email:"pat@greenedge.com",phone:"(720) 555-0189",value:1057,stage:"Closed Won",pipeline:"Client",flag:"green",notes:"Signed!",website:"greenedge.com",location:"Boulder, CO",campaignName:"CO Landscaping",leadCategory:"Interested",slLeadId:"",slCampaignId:"",smartleadUrl:"",createdDate:"2025-01-28",lastUpdated:TODAY()},
];

const TEST_ACTIVITIES = [
  {id:"a1",dealId:"t1",type:"Call",subject:"Call #1 - immediate",dueDate:TODAY(),done:false,dayLabel:"Day 1"},
  {id:"a2",dealId:"t1",type:"Text",subject:"Initial text",dueDate:TODAY(),done:true,dayLabel:"Day 1"},
  {id:"a3",dealId:"t1",type:"Email",subject:"Initial email",dueDate:TODAY(),done:false,dayLabel:"Day 1"},
  {id:"a4",dealId:"t2",type:"Call",subject:"Morning call",dueDate:YESTERDAY,done:false,dayLabel:"Day 2"},
  {id:"a5",dealId:"t2",type:"Email",subject:"Follow-up email",dueDate:TOMORROW,done:false,dayLabel:"Day 2"},
  {id:"a6",dealId:"t4",type:"Discovery Call",subject:"Discovery call",dueDate:TOMORROW,done:false,dayLabel:""},
];

const TEST_CLIENTS = [
  {id:"c1",name:"GreenScapes Tampa",color:"#2563eb"},
  {id:"c2",name:"Premier Lawns Austin",color:"#7c3aed"},
  {id:"c3",name:"Elite Grounds Denver",color:"#059669"},
];

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
function fmt$(v){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0}).format(v||0)}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function str(v){return v===null||v===undefined?'':String(v)}

// Find matching client for a deal based on campaign keywords
function findClientForDeal(deal){
  const cn=str(deal.campaignName).toLowerCase();
  if(!cn) return null;
  for(const c of state.clients){
    const keywords=str(c.campaignKeywords).toLowerCase().split(',').map(k=>k.trim()).filter(k=>k);
    for(const kw of keywords){
      if(cn.includes(kw)) return c;
    }
  }
  return null;
}

// Forward deal to matched client via Apps Script (email + optional SMS)
async function forwardDealToClient(dealId){
  const deal=state.deals.find(d=>d.id===dealId);
  if(!deal) return;
  const client=findClientForDeal(deal) || state.clients.find(c=>c.name===deal.stage);
  if(!client){alert('No client matched for this campaign. Add campaign keywords in Settings ‚Üí Clients.');return;}
  if(deal.forwardedAt && str(deal.forwardedAt).trim()!==''){alert('Already forwarded.');return;}
  
  // Show preview modal
  showForwardPreview(deal, client);
}

function showForwardPreview(deal, client){
  const overlay=document.createElement('div');
  overlay.id='fwd-preview-overlay';
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:20000;display:flex;align-items:center;justify-content:center';
  overlay.onclick=e=>{if(e.target===overlay){overlay.remove();}};

  const companyName=deal.company||'Unknown Company';
  const contactName=deal.contact||'';
  const leadEmail=deal.email||'';
  const leadPhone=deal.phone||'';
  const leadMobilePhone=deal.mobilePhone||'';
  const leadWebsite=deal.website||'';
  const leadLocation=deal.location||'';
  const smartleadUrl=deal.smartleadUrl||'';
  const notifyEmails=str(client.notifyEmails).split(',').map(e=>e.trim()).filter(e=>e);

  let emailPreview=`
    <div style="background:#1a1a2e;color:#fff;padding:20px 24px;border-radius:8px 8px 0 0">
      <h2 style="margin:0;font-size:18px">New Lead from Your Campaign</h2>
    </div>
    <div style="background:#fff;padding:24px;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px">
      <table style="width:100%;border-collapse:collapse;font-size:14px">
        <tr><td style="padding:8px 0;color:#888;width:120px">Company</td><td style="padding:8px 0;font-weight:bold">${esc(companyName)}</td></tr>
        ${contactName?`<tr><td style="padding:8px 0;color:#888">Contact</td><td style="padding:8px 0">${esc(contactName)}</td></tr>`:''}
        ${leadWebsite?`<tr><td style="padding:8px 0;color:#888">Website</td><td style="padding:8px 0;color:#2563eb">${esc(leadWebsite)}</td></tr>`:''}
        ${leadEmail?`<tr><td style="padding:8px 0;color:#888">Email</td><td style="padding:8px 0;color:#2563eb">${esc(leadEmail)}</td></tr>`:''}
        ${leadPhone?`<tr><td style="padding:8px 0;color:#888">Business Phone</td><td style="padding:8px 0">${esc(leadPhone)}</td></tr>`:''}
        ${leadMobilePhone?`<tr><td style="padding:8px 0;color:#888">Mobile Phone</td><td style="padding:8px 0">${esc(leadMobilePhone)}</td></tr>`:''}
        ${leadLocation?`<tr><td style="padding:8px 0;color:#888">Address</td><td style="padding:8px 0">${esc(leadLocation)}</td></tr>`:''}
      </table>
      ${smartleadUrl?`<div style="margin-top:20px"><span style="display:inline-block;background:#2563eb;color:#fff;padding:10px 24px;border-radius:6px;font-weight:bold;font-size:14px">Click to Reply ‚Üí</span></div>`:''}
      <p style="margin-top:20px;color:#888;font-size:12px">Go get em while they're hot!</p>
    </div>`;

  // Missing fields warning
  const missing=[];
  if(!contactName) missing.push('Contact Name');
  if(!leadEmail) missing.push('Email');
  if(!leadPhone && !leadMobilePhone) missing.push('Phone (Business or Mobile)');
  if(!leadWebsite) missing.push('Website');
  if(!leadLocation) missing.push('Address');
  if(!smartleadUrl) missing.push('Smartlead Reply Link');

  let warningHtml='';
  if(missing.length){
    warningHtml=`<div style="padding:10px 14px;background:#fef3c7;border:1px solid #fde68a;border-radius:8px;margin-bottom:14px;font-size:12px;color:#92400e">
      ‚ö†Ô∏è Missing fields: ${missing.join(', ')}
    </div>`;
  }

  const modal=document.createElement('div');
  modal.style.cssText='background:#fff;border-radius:12px;width:560px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)';
  modal.innerHTML=`
    <div style="padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0;font-size:16px;color:#111">Preview: Email to ${esc(client.name)}</h3>
        <p style="margin:4px 0 0;font-size:12px;color:#6b7280">Sending to: ${esc(notifyEmails.join(', ')||'No emails configured!')}</p>
      </div>
      <button onclick="this.closest('#fwd-preview-overlay').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;padding:4px">√ó</button>
    </div>
    <div style="padding:20px">
      ${warningHtml}
      <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;font-family:Arial,sans-serif">
        ${emailPreview}
      </div>
    </div>
    <div style="padding:14px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px">
      <button onclick="this.closest('#fwd-preview-overlay').remove()" class="btn" style="background:#f9fafb;color:#6b7280;border:1px solid #e5e7eb">Cancel</button>
      <button id="fwd-confirm-btn" onclick="confirmForward('${deal.id}')" class="btn forward-btn ready" style="width:auto;padding:8px 24px">üìß Send to ${esc(client.name)}</button>
    </div>`;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

async function confirmForward(dealId){
  const btn=document.getElementById('fwd-confirm-btn');
  if(btn){btn.textContent='Sending...';btn.disabled=true;}
  
  try{
    const resp=await apiPost('forward_to_client',{dealId:dealId});
    if(!resp || resp.error){
      const errMsg=resp?resp.error:'No response from server ‚Äî check Apps Script deployment';
      alert('Forward failed: '+errMsg);
      if(btn){btn.textContent='üìß Retry';btn.disabled=false;}
      return;
    }
    const deal=state.deals.find(d=>d.id===dealId);
    if(deal) deal.forwardedAt=new Date().toISOString();

    // Auto-push to Lead Tracker
    if(deal){
      try{
        await autoPushToTracker(deal);
      }catch(e){
        console.error('Lead Tracker auto-push failed:',e);
      }
    }

    document.getElementById('fwd-preview-overlay')?.remove();
    refreshModal();
  }catch(e){
    alert('Forward failed: '+e.message);
    if(btn){btn.textContent='üìß Retry';btn.disabled=false;}
  }
}

// Centralized Lead Tracker push used by both Forward and Won zone
async function autoPushToTracker(deal){
  const client=findClientForDeal(deal) || state.clients.find(c=>c.name===deal.stage);
  const clientName=client?client.name:deal.stage;
  if(!clientName){console.warn('No client name for tracker push');return;}
  const now=new Date();
  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthGenerated=monthNames[now.getMonth()]+'/'+String(now.getFullYear()).slice(2);
  const dateGenerated=(now.getMonth()+1)+'/'+now.getDate()+'/'+String(now.getFullYear()).slice(2);
  const leadName=deal.company||deal.contact||'Unknown';
  const leadEmail=deal.email||'';
  // Get cost from client config, or from deal value, or prompt
  let cost='';
  if(client && str(client.leadCost).replace(/[^0-9.]/g,'')){
    cost='$'+str(client.leadCost).replace(/[^0-9.]/g,'');
  } else if(deal.value && String(deal.value)!=='0'){
    cost='$'+String(deal.value);
  }
  const row=[clientName,monthGenerated,leadName,leadEmail,dateGenerated,cost,'','','',''];
  const resp=await apiPost('push_lead_tracker',{sheetId:LEAD_TRACKER_SHEET_ID,sheetName:'Lead Tracker',row});
  if(resp && !resp.error){
    deal.pushedToTracker=new Date().toISOString();
    // Persist the pushedToTracker timestamp to the sheet
    pendingWrites++;
    apiPost('update_deal',{id:deal.id,pushedToTracker:deal.pushedToTracker}).finally(()=>{pendingWrites--;});
    console.log('Lead Tracker push success:',leadName,'‚Üí',clientName);
  } else {
    console.error('Lead Tracker push response:',resp);
    throw new Error(resp?resp.error:'Push failed');
  }
}
function fmtDate(d){
  if(!d) return '';
  const s=(d||'').slice(0,10); // "2026-02-12"
  if(!s||s.length<10) return s;
  const today=getToday();
  const tom=new Date();tom.setDate(tom.getDate()+1);
  const tomStr=tom.getFullYear()+'-'+String(tom.getMonth()+1).padStart(2,'0')+'-'+String(tom.getDate()).padStart(2,'0');
  if(s===today) return 'Today';
  if(s===tomStr) return 'Tomorrow';
  const parts=s.split('-');
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[parseInt(parts[1])-1]+' '+parseInt(parts[2]);
}

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let state = {
  deals: [],
  activities: [],
  clients: [...TEST_CLIENTS],
  pipeline: (() => { try { const h=location.hash.replace('#',''); return ['acquisition','client_leads','nurture'].includes(h)?h:'acquisition'; } catch(e){ return 'acquisition'; } })(),
  selectedDeal: null,
  showNew: false,
  showAddClient: false,
  showSop: false,
  dragId: null,
  overCol: null,
  synced: false,
  syncing: false,
  loadFailed: false,
  searchQuery: "",
  searchResults: null,
  savedSettings: null,
};

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ
async function apiGet(action){
  try {
    const r=await fetch(API_URL+"?action="+action, {redirect:"follow"});
    const text=await r.text();
    try { return JSON.parse(text); } catch(e) { console.warn("Parse error:",text.slice(0,200)); return null; }
  }
  catch(e){ console.warn("API GET error:",e); return null; }
}
async function apiPost(action,data,retries=2){
  for(let attempt=0; attempt<=retries; attempt++){
    try {
      const r=await fetch(API_URL,{method:"POST",redirect:"follow",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action,data})});
      const text=await r.text();
      try { 
        const parsed=JSON.parse(text); 
        // If server returned valid JSON with an error, return it to the caller (don't retry)
        if(parsed && parsed.error) return parsed;
        if(parsed) return parsed;
      } catch(e) {}
      // Couldn't parse as JSON ‚Äî retry
      if(attempt<retries){ await new Promise(ok=>setTimeout(ok,800*(attempt+1))); continue; }
      return null;
    } catch(e){
      console.warn("API POST error (attempt "+(attempt+1)+"):",e);
      if(attempt<retries){ await new Promise(ok=>setTimeout(ok,800*(attempt+1))); continue; }
      return null;
    }
  }
}

async function syncFromSheet(){
  if(state.selectedDeal) return; // Don't sync while editing
  if(state.showNew) return; // Don't sync while creating new deal
  if(state.showAddClient) return; // Don't sync while adding client
  if(pendingWrites > 0) return; // Don't sync while writes are in-flight
  state.syncing=true; render();
  const data=await apiGet("get_all");
  if(data && !data.error){
    if(data.deals && Array.isArray(data.deals)) {
      state.deals=data.deals.filter(d=>!deletedDealIds.has(String(d.id)));
      // Normalize ALL fields to strings (Sheets returns numbers for IDs, phones, etc.)
      state.deals.forEach(d=>{
        Object.keys(d).forEach(k=>{
          if(d[k]!=null && typeof d[k]!=='string') d[k]=String(d[k]);
        });
        if(d.phone && (d.phone.includes('#ERROR') || d.phone.includes('ERROR'))) d.phone='';
        // Clean "0" values that should be empty
        if(d.value==='0') d.value='';
      });
    }
    if(data.activities && Array.isArray(data.activities)) {
      state.activities=data.activities.filter(a=>!deletedActivityIds.has(String(a.id)));
      // Normalize all activity fields to strings too
      state.activities.forEach(a=>{
        Object.keys(a).forEach(k=>{
          if(k==='done'){ a[k]=(a[k]===true||a[k]==='true'||a[k]==='TRUE'); return; }
          if(a[k]!=null && typeof a[k]!=='string') a[k]=String(a[k]);
        });
      });
    }
    if(data.clients && Array.isArray(data.clients) && data.clients.length>0){
      state.clients=data.clients;
      // Apply default Calendly URLs for known clients if not already set
      for(const c of state.clients){
        if(!c.calendlyUrl){
          // Try exact match first, then partial match
          const match = DEFAULT_CALENDLY_URLS[c.name] || Object.entries(DEFAULT_CALENDLY_URLS).find(([k])=>{
            const cn=c.name.toLowerCase().replace(/[^a-z]/g,'');
            const kn=k.toLowerCase().replace(/[^a-z]/g,'');
            return cn.includes(kn) || kn.includes(cn);
          })?.[1];
          if(match) c.calendlyUrl = match;
        }
      }
    }
    if(data.settings && typeof data.settings==='object' && Object.keys(data.settings).length>0) applySettings(data.settings);
    state.synced=true;
    state.loadFailed=false;
  } else {
    if(state.deals.length===0){
      state.deals=[...TEST_DEALS];
      state.activities=[...TEST_ACTIVITIES];
      state.loadFailed=true;
    }
  }
  state.syncing=false; render();
}

// ‚îÄ‚îÄ‚îÄ Global Search ‚îÄ‚îÄ‚îÄ
function globalSearch(q){
  state.searchQuery=q;
  if(!q||q.length<1){state.searchResults=null;render();return;}
  const lq=q.toLowerCase().trim();
  const digits=q.replace(/[^0-9]/g,'');
  const isDigitQuery=digits.length>=2 && digits.length===q.replace(/[\s\-\(\)\+]/g,'').length;
  state.searchResults=state.deals.filter(d=>{
    if(isDigitQuery){
      const ph=(d.phone||'').replace(/[^0-9]/g,'');
      if(ph.includes(digits))return true;
      if(ph.length>1 && ph.startsWith('1') && ph.slice(1).includes(digits))return true;
      return false;
    }
    if((d.company||'').toLowerCase().includes(lq))return true;
    if((d.contact||'').toLowerCase().includes(lq))return true;
    if((d.email||'').toLowerCase().includes(lq))return true;
    if((d.website||'').toLowerCase().includes(lq))return true;
    if((d.notes||'').toLowerCase().includes(lq))return true;
    return false;
  }).slice(0,15);
  render();
}
function clearSearch(){state.searchQuery="";state.searchResults=null;render();}

// ‚îÄ‚îÄ‚îÄ Activity Badge Logic ‚îÄ‚îÄ‚îÄ
function getActivityBadge(dealId){
  const pending=state.activities.filter(a=>a.dealId===dealId && !a.done && String(a.done)!=="TRUE");
  if(!pending.length) return null;
  const today=getToday();
  // Normalize dueDates to date-only (YYYY-MM-DD) - activities are all-day by default
  const dateOnly=d=>(d||'').slice(0,10);
  const hasOverdue=pending.some(a=>dateOnly(a.dueDate)<today);
  const hasDueToday=pending.some(a=>dateOnly(a.dueDate)===today);
  if(hasOverdue) return {color:"#ef4444",count:pending.length,label:"overdue"};
  if(hasDueToday) return {color:"#22c55e",count:pending.length,label:"due today"};
  return {color:"#9ca3af",count:pending.length,label:"upcoming"};
}

// ‚îÄ‚îÄ‚îÄ Get stages for current pipeline ‚îÄ‚îÄ‚îÄ
function getStages(){
  if(state.pipeline==="acquisition") return ACQUISITION_STAGES;
  if(state.pipeline==="nurture") return NURTURE_STAGES;
  // Client Leads: fixed "Not Distributed" column + dynamic client columns
  const clientCols=state.clients.map((c,i)=>({id:c.name,label:c.name,color:c.color||CLIENT_PALETTE[i%CLIENT_PALETTE.length]}));
  return [{id:"Client Not Distributed",label:"Not Distributed",color:"#6b7280"},...clientCols];
}

// ‚îÄ‚îÄ‚îÄ Filter deals for pipeline ‚îÄ‚îÄ‚îÄ
function getPipelineDeals(){
  if(state.pipeline==="acquisition"){
    return state.deals.filter(d=>ACQUISITION_STAGES.some(s=>s.id===d.stage));
  }
  if(state.pipeline==="nurture") return state.deals.filter(d=>NURTURE_STAGES.some(s=>s.id===d.stage));
  // Client leads - "Client Not Distributed" + client name columns
  const clientNames=state.clients.map(c=>c.name);
  return state.deals.filter(d=>d.stage==="Client Not Distributed"||clientNames.includes(d.stage));
}

// ‚îÄ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ
async function createDeal(form){
  const pip=state.pipeline==="acquisition"?"Acquisition":state.pipeline==="nurture"?"Nurture":"Client";
  const deal={...form,id:uid(),pipeline:pip,flag:"",createdDate:TODAY(),lastUpdated:TODAY()};
  state.deals.push(deal);render();
  await apiPost("create_deal",deal);
}

async function saveDeal(updated){
  state.deals=state.deals.map(d=>d.id===updated.id?{...d,...updated,lastUpdated:TODAY()}:d);
  state.selectedDeal=null;render();
  pendingWrites++;
  try { await apiPost("update_deal",updated); }
  finally { pendingWrites--; }
}

async function deleteDeal(id){
  deletedDealIds.add(id);
  state.deals=state.deals.filter(d=>d.id!==id);
  state.activities=state.activities.filter(a=>a.dealId!==id);
  state.selectedDeal=null;render();
  await apiPost("delete_deal",{id});
}

// cycleFlag removed - replaced with activity status dots

async function moveDeal(dealId,newStage){
  const d=state.deals.find(x=>x.id===dealId);
  if(d){d.stage=newStage;d.lastUpdated=TODAY();}
  render();
  pendingWrites++;
  try { await apiPost("move_deal_stage",{id:dealId,stage:newStage}); }
  finally { pendingWrites--; }
}

function addActivity(dealId,act){
  const a={id:uid(),dealId,type:act.type,subject:act.subject||act.type,dueDate:act.dueDate||TODAY(),done:false,dayLabel:act.dayLabel||"",createdDate:new Date().toISOString(),completedAt:""};
  state.activities.push(a);
  refreshModal();
  pendingWrites++;
  apiPost("create_activity",a).finally(()=>{ pendingWrites--; });
}

// Fast modal refresh ‚Äî swaps inner content without destroying the overlay element
function refreshModal(){
  if(!state.selectedDeal) return;
  const overlay=document.querySelector('.modal-overlay');
  if(overlay){
    // Save scroll position of the modal content
    const modal=overlay.querySelector('.modal');
    const savedScroll=modal?modal.scrollTop:0;
    // Save currently focused input so we don't lose user's typing
    const focused=document.activeElement;
    let focusId=null, focusVal=null, focusSel=null;
    if(focused && (focused.tagName==='INPUT'||focused.tagName==='TEXTAREA'||focused.tagName==='SELECT')){
      focusId=focused.id;
      focusVal=focused.value;
      focusSel=focused.selectionStart;
    }
    // Build fresh modal HTML
    const fresh=renderDealModal(state.selectedDeal);
    const tmp=document.createElement('div');
    tmp.innerHTML=fresh;
    const newOverlay=tmp.firstElementChild;
    if(newOverlay) overlay.innerHTML=newOverlay.innerHTML;
    // Restore scroll position
    const newModal=overlay.querySelector('.modal');
    if(newModal) newModal.scrollTop=savedScroll;
    // Restore focus and value
    if(focusId){
      const el=document.getElementById(focusId);
      if(el){
        el.value=focusVal;
        el.focus();
        if(el.setSelectionRange && focusSel!==null && el.tagName!=='SELECT'){
          try{el.setSelectionRange(focusSel,focusSel);}catch(e){}
        }
      }
    }
  } else {
    render();
  }
}

function updateActivityDate(actId, newDate){
  const sid=String(actId);
  const a=state.activities.find(x=>String(x.id)===sid);
  if(!a) return;
  a.dueDate=newDate;
  refreshModal();
  pendingWrites++;
  apiPost("update_activity",{id:sid,dueDate:newDate}).finally(()=>{ pendingWrites--; });
}

function toggleActivity(actId){
  const sid=String(actId);
  const a=state.activities.find(x=>String(x.id)===sid);
  if(!a) return;
  a.done=!a.done;
  a.completedAt=a.done?new Date().toISOString():"";
  refreshModal();
  pendingWrites++;
  apiPost("update_activity",{id:sid,done:a.done,completedAt:a.completedAt}).finally(()=>{ pendingWrites--; });
}

function deleteActivity(actId){
  const sid=String(actId);
  deletedActivityIds.add(sid);
  state.activities=state.activities.filter(a=>String(a.id)!==sid);
  refreshModal();
  pendingWrites++;
  apiPost("delete_activity",{id:sid}).finally(()=>{ pendingWrites--; });
}

function assignSequence(dealId,dayLabel,acts,targetDate){
  const newActs=[];
  for(const a of acts){
    const na={id:uid(),dealId,type:a.type,subject:a.subject,dueDate:targetDate||TODAY(),done:false,dayLabel};
    state.activities.push(na);
    newActs.push(na);
  }
  refreshModal();
  // Create activities sequentially to avoid overwhelming Apps Script
  pendingWrites++;
  (async ()=>{
    for(const na of newActs){
      await apiPost("create_activity",na);
    }
    pendingWrites--;
  })();
}

function copyLeadInfo(dealId){
  const deal=state.deals.find(d=>d.id===dealId);
  if(!deal) return;
  const client=state.clients.find(c=>c.name===deal.stage);
  // Get client first name
  let clientFirst='';
  if(client){
    const n=String(client.name||'').trim();
    // Try first word, but skip common prefixes
    clientFirst=n.split(/\s+/)[0]||n;
  }
  const biz=deal.company||deal.contact||'';
  const lines=[];
  lines.push('Hey '+(clientFirst||'there')+', Just scheduled a quote request for {day} at {time} with '+biz+'. The address, phone, contact info and instructions are all included in that calendar event. I\'ve also added you to the email thread. Please check your spam folder if you are not seeing it.');
  lines.push('');
  if(biz) lines.push('Business: '+biz);
  if(deal.address) lines.push('Address: '+deal.address);
  else if(deal.location) lines.push('Address: '+deal.location);
  if(deal.phone) lines.push('Business Phone: '+deal.phone);
  if(deal.email) lines.push('Email: '+deal.email);
  const text=lines.join('\n');
  navigator.clipboard.writeText(text).then(()=>{
    const btn=event.target.closest('button');
    if(btn){ const orig=btn.innerHTML; btn.innerHTML='‚úÖ Copied!'; setTimeout(()=>btn.innerHTML=orig, 1500); }
  }).catch(()=>{
    prompt('Copy this text:',text);
  });
}

function buildCalendlyUrl(baseUrl, deal){
  const url = new URL(baseUrl.includes('://') ? baseUrl : 'https://'+baseUrl);
  const name = deal.contact || deal.company || '';
  if(name) url.searchParams.set('name', name);
  // Pack all deal info into the notes/comments field (a1) ‚Äî only instructions left blank
  const lines = [];
  if(deal.company) lines.push('Business: ' + deal.company);
  if(deal.address) lines.push('Address: ' + deal.address);
  else if(deal.location) lines.push('Address: ' + deal.location);
  if(deal.phone) lines.push('Business Phone: ' + deal.phone);
  if(deal.mobilePhone) lines.push('Mobile Phone: ' + deal.mobilePhone);
  if(deal.email) lines.push('Email: ' + deal.email);
  if(deal.contact && deal.contact !== deal.company) lines.push('Contact: ' + deal.contact);
  lines.push('');
  lines.push('Instructions: ');
  if(lines.length) url.searchParams.set('a1', lines.join('\n'));
  return url.toString();
}

async function addClient(name){
  const c={id:uid(),name,color:CLIENT_PALETTE[state.clients.length%CLIENT_PALETTE.length],calendlyUrl:''};
  state.clients.push(c);render();
  await apiPost("create_client",c);
}

function removeClient(name){
  state.clients=state.clients.filter(c=>c.name!==name);render();
}

const LEAD_TRACKER_SHEET_ID='1zEfZQOuzbrE9s01gfTOoVvEJ-DgtOxkPIWNiZHaxaZ4';
async function pushToLeadTracker(dealId){
  const deal=state.deals.find(d=>d.id===dealId);
  if(!deal) return;
  const client=findClientForDeal(deal) || state.clients.find(c=>c.name===deal.stage);
  let leadCost='';
  if(client && str(client.leadCost).replace(/[^0-9.]/g,'')){
    leadCost='$'+str(client.leadCost).replace(/[^0-9.]/g,'');
  } else {
    const costInput=prompt('Enter lead cost for this client (e.g. 200, 250):','250');
    if(costInput===null) return;
    const costNum=parseFloat(costInput.replace(/[^0-9.]/g,''));
    if(isNaN(costNum)){alert('Invalid cost. Please enter a number.');return;}
    leadCost='$'+costNum;
  }
  const now=new Date();
  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthGenerated=monthNames[now.getMonth()]+'/'+String(now.getFullYear()).slice(2);
  const dateGenerated=(now.getMonth()+1)+'/'+now.getDate()+'/'+String(now.getFullYear()).slice(2);
  const clientName=client?client.name:deal.stage;
  const leadName=deal.company||deal.contact||'Unknown';
  const leadEmail=deal.email||'';
  const row=[clientName,monthGenerated,leadName,leadEmail,dateGenerated,leadCost,'','','',''];
  // INSTANT UI update ‚Äî mark as pushed immediately, fire API in background
  deal.pushedToTracker=new Date().toISOString();
  render();
  // Background API calls ‚Äî fire and forget
  apiPost('push_lead_tracker',{sheetId:LEAD_TRACKER_SHEET_ID,sheetName:'Lead Tracker',row}).catch(e=>{
    console.error('Lead Tracker push failed:',e);
  });
  pendingWrites++;
  apiPost('update_deal',{id:deal.id,pushedToTracker:deal.pushedToTracker}).finally(()=>{pendingWrites--;});
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function render(){
  try{
  const app=document.getElementById("app");
  // Save scroll position before destroying DOM
  const board=document.querySelector('.board');
  if(board) savedScrollLeft=board.scrollLeft;
  const stages=getStages();
  const deals=getPipelineDeals();
  const totalValue=deals.reduce((s,d)=>s+(Number(d.value)||0),0);
  const totalDeals=deals.length;

  let html=`
  <div class="topbar">
    <div style="display:flex;align-items:center;">
      <div class="topbar-tabs">
        ${PIPELINES.map(p=>`<button class="topbar-tab ${state.pipeline===p.id?'active':''}" onclick="state.pipeline='${p.id}';location.hash='${p.id}';render()">${p.label}</button>`).join("")}
      </div>
    </div>
    <div class="topbar-right">
      <div class="search-wrapper">
        <input type="text" class="search-input" id="search-input" placeholder="Search all deals..." value="${esc(state.searchQuery)}"
          oninput="globalSearch(this.value)" onfocus="if(this.value.length>=1)globalSearch(this.value)">
        ${state.searchQuery?'<span class="search-clear" onclick="clearSearch()">√ó</span>':''}
        ${state.searchResults!==null?`<div class="search-dropdown">
          ${state.searchResults.length===0?'<div class="search-empty">No deals found</div>':''}
          ${state.searchResults.map(d=>`
            <div class="search-result-item" onmousedown="event.preventDefault();clearSearch();openDeal('${d.id}')">
              <div class="search-result-main">
                <span class="search-result-name">${esc(d.company||d.contact||'Unknown')}</span>
                <span class="search-result-stage">${esc(d.stage||'')}</span>
              </div>
              <div class="search-result-meta">
                ${d.contact&&d.contact!==d.company?`<span>${esc(d.contact)}</span>`:''}
                ${d.email?`<span>${esc(d.email)}</span>`:''}
                ${d.phone?`<span>${esc(d.phone)}</span>`:''}
              </div>
            </div>`).join('')}
        </div>`:''}
      </div>
      <span class="topbar-stat">${state.loadFailed?'‚ö†Ô∏è Offline (test data)':state.synced?'‚úì Connected':'Connecting...'}${state.synced?' ¬∑ ':' '}${totalDeals} deals ¬∑ ${fmt$(totalValue)}${state.syncing?' ‚Üª':''}</span>
      <button class="btn btn-ghost" onclick="syncFromSheet()">‚Üª Sync</button>
      ${state.pipeline==='client_leads'?'<button class="btn btn-ghost" onclick="openAddClient()">+ Client</button>':''}
      <button class="btn btn-primary" onclick="openNewDeal()">+ Deal</button>
      <button class="btn btn-ghost" onclick="openSettings()" title="Settings" style="font-size:16px;padding:6px 10px">‚öôÔ∏è</button>
      ${currentUser?`<button class="btn btn-ghost" onclick="logout()" title="Sign out (${esc(currentUser.name)})" style="font-size:11px;padding:5px 10px;color:#9ca3af">${esc(currentUser.name)} ‚Üó</button>`:''}
    </div>
  </div>
  <div class="board">`;

  // Search results handled inline in search dropdown

  for(const stage of stages){
    const sd=deals.filter(d=>d.stage===stage.id);
    const sv=sd.reduce((s,d)=>s+(Number(d.value)||0),0);
    const stageKey=btoa(unescape(encodeURIComponent(stage.id)));

    html+=`<div class="column" data-stage-key="${stageKey}"
      ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';doDragOver(this)"
      ondragleave="doDragLeave(event,this)"
      ondrop="doDrop('${stageKey}')">
      <div class="col-header" style="border-top-color:${stage.color}">
        <div>
          <div class="col-title">${esc(stage.label)}</div>
          <div class="col-meta">${fmt$(sv)} ¬∑ ${sd.length} deal${sd.length!==1?'s':''}</div>
        </div>
        ${state.pipeline==='client_leads'?`<div style="display:flex;gap:6px;align-items:center">
          ${(()=>{const cl=state.clients.find(c=>c.name===stage.label);return cl&&cl.calendlyUrl?'<a href="'+esc(cl.calendlyUrl)+'" target="_blank" rel="noopener" title="Open Calendly for '+esc(stage.label)+'" style="background:none;border:none;color:#818cf8;font-size:14px;cursor:pointer;text-decoration:none" onclick="event.stopPropagation()">üìÖ</a>':'';})()}
          <button style="background:none;border:none;color:#d1d5db;font-size:14px;cursor:pointer" onclick="if(confirm('Remove this client?'))removeClient(atob('${btoa(unescape(encodeURIComponent(stage.label)))}'))">√ó</button>
        </div>`:''}
      </div>
      <div class="col-body" ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';doDragOver(this.closest('.column'))" ondrop="doDrop('${stageKey}')">`;

    if(sd.length===0){
      html+=`<div class="col-empty" ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';doDragOver(this.closest('.column'))" ondrop="doDrop('${stageKey}')">Drop deals here</div>`;
    } else {
      for(const deal of sd){
        const badge=getActivityBadge(deal.id);
        html+=`<div class="deal-card" draggable="true"
          ondragstart="event.dataTransfer.effectAllowed='move';state.dragId='${deal.id}';showDeleteZone()"
          ondragend="clearAllDragOver();hideDeleteZone()"
          ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';doDragOver(this.closest('.column'))"
          ondrop="doDrop('${stageKey}')"
          data-deal-id="${deal.id}"
          onclick="openDeal('${deal.id}')">
          <div class="deal-card-top">
            <div class="deal-company">${esc(deal.company||deal.contact||deal.email||"New Deal")}</div>
            <div class="status-indicator" onclick="event.stopPropagation();toggleBadgeDropdown('${deal.id}')">
              <div class="status-dot" style="background:${badge?badge.color:'#d1d5db'}"></div>
              ${badge?`<span class="status-count" style="color:${badge.color}">${badge.count}</span>`:''}
              ${badge?`<div class="badge-dropdown" id="badge-${deal.id}" style="display:none">
                  <div class="badge-dropdown-title">${badge.label} (${badge.count})</div>
                  ${state.activities.filter(a=>a.dealId===deal.id&&!a.done&&String(a.done)!=="TRUE").map(a=>`
                    <div class="badge-item">
                      <span>${ACTIVITY_ICONS[a.type]||"\u2713"}</span>
                      <span style="flex:1;color:#374151">${esc(a.subject||a.type)}</span>
                      <span style="font-size:10px;color:#9ca3af">${fmtDate(a.dueDate)}</span>
                    </div>`).join("")}
                </div>`:''}
            </div>
          </div>
          ${deal.contact&&deal.contact!==deal.company?`<div class="deal-contact">${esc(deal.contact)}</div>`:''}
          ${deal.email?`<div class="deal-detail">${esc(deal.email)}</div>`:''}
          ${deal.phone?`<div class="deal-detail">${esc(deal.phone)}</div>`:''}
          <div class="deal-bottom">
            <span class="deal-value" style="color:${deal.value?'#059669':'#d1d5db'}">${fmt$(deal.value)}</span>
            ${deal.leadCategory?`<span class="deal-tag">${esc(deal.leadCategory)}</span>`:''}
          </div>
          ${deal.emailBody?`<div class="deal-reply-snippet" title="${esc(deal.emailBody)}">${esc(String(deal.emailBody).substring(0,80))}${String(deal.emailBody).length>80?'‚Ä¶':''}</div>`:''}
        </div>`;
      }
    }
    html+=`</div></div>`;
  }

  html+=`</div>`;

  // Drag-to-delete/won zone
  html+=`<div class="delete-zone" id="delete-zone">
    <div class="delete-zone-half delete-zone-lost"
      ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';this.classList.add('drag-hover')"
      ondragleave="this.classList.remove('drag-hover')"
      ondrop="doLostDrop()">üóëÔ∏è Lost / Delete</div>
    <div class="delete-zone-half delete-zone-won"
      ondragover="event.preventDefault();event.dataTransfer.dropEffect='move';this.classList.add('drag-hover')"
      ondragleave="this.classList.remove('drag-hover')"
      ondrop="doWonDrop()">‚úÖ Won ‚Üí Push to Tracker</div>
  </div>`;

  // Modals
  if(state.selectedDeal) html+=renderDealModal(state.selectedDeal);
  if(state.showNew) html+=renderNewDealModal(stages);
  if(state.showAddClient) html+=renderAddClientModal();

  app.innerHTML=html;
  // Restore scroll position
  const newBoard=document.querySelector('.board');
  if(newBoard && savedScrollLeft>0) newBoard.scrollLeft=savedScrollLeft;
  app.querySelectorAll('.deal-card[data-deal-id]').forEach(card=>{
    let downTime=0, downX=0, downY=0;
    card.addEventListener('mousedown',function(e){
      downTime=Date.now(); downX=e.clientX; downY=e.clientY;
    });
    card.addEventListener('mouseup',function(e){
      const dt=Date.now()-downTime;
      const dx=Math.abs(e.clientX-downX);
      const dy=Math.abs(e.clientY-downY);
      console.log('Card mouseup:', this.dataset.dealId, 'dt:', dt, 'dx:', dx, 'dy:', dy);
      // Only open if it was a quick tap (< 300ms) with minimal movement (< 5px)
      if(dt<300 && dx<5 && dy<5){
        if(e.target.closest('.status-indicator')||e.target.closest('button'))return;
        openDeal(this.dataset.dealId);
      }
    });
  });
  // Restore search input focus and cursor
  if(state.searchQuery){
    const si=document.getElementById('search-input');
    if(si){si.focus();si.setSelectionRange(si.value.length,si.value.length);}
  }
  }catch(err){console.error('Render error:',err,err.stack);}
}

function getStagesForPipeline(pip){
  if(pip==='Acquisition') return ACQUISITION_STAGES;
  if(pip==='Nurture') return NURTURE_STAGES;
  // Client
  const clientCols=state.clients.map((c,i)=>({id:c.name,label:c.name,color:c.color||CLIENT_PALETTE[i%CLIENT_PALETTE.length]}));
  return [{id:"Client Not Distributed",label:"Not Distributed",color:"#6b7280"},...clientCols];
}

function renderDealModal(deal){
  const stages=getStagesForPipeline(deal.pipeline||'Client');
  const dealActs=state.activities.filter(a=>a.dealId===deal.id);
  const pending=dealActs.filter(a=>!a.done&&String(a.done)!=="TRUE");
  const completed=dealActs.filter(a=>a.done||String(a.done)==="TRUE");

  let h=`<div class="modal-overlay" onclick="closeDealModal()">
    <div class="modal" style="width:520px" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Edit Deal</h3><button class="modal-close" onclick="closeDealModal()">√ó</button></div>
      <div class="modal-body">
        <div class="form-grid">
          ${["company:Company","contact:Contact Name","email:Email","phone:Business Phone","mobilePhone:Mobile Phone","website:Website","location:Address","value:Deal Value ($)"].map(f=>{
            const[k,label]=f.split(":");
            let extra='';
            if((k==='phone'||k==='mobilePhone')&&deal[k]){
              const cleanNum=String(deal[k]||'').replace(/[^0-9+]/g,'');
              extra='<div style="margin-top:4px;display:flex;gap:6px"><a href="sms:'+cleanNum+'" class="imessage-btn" title="Open in iMessage">üí¨ Text</a><a href="tel:'+cleanNum+'" class="imessage-btn" title="Call from computer">üìû Call</a></div>';
            }
            return'<div class="form-group"><label>'+label+'</label><input id="deal-'+k+'" value="'+esc(String(deal[k]||''))+'" oninput="updateDealField(\''+k+'\',this.value)">'+extra+'</div>';
          }).join("")}
          <div class="form-group">
            <label>Pipeline</label>
            <select id="deal-pipeline" onchange="changeDealPipeline(this.value)">
              <option value="Acquisition" ${deal.pipeline==='Acquisition'?'selected':''}>Acquisition</option>
              <option value="Client" ${deal.pipeline==='Client'?'selected':''}>Client Leads</option>
              <option value="Nurture" ${deal.pipeline==='Nurture'?'selected':''}>Long Term Nurture</option>
            </select>
          </div>
          <div class="form-group">
            <label>Stage</label>
            <select id="deal-stage" onchange="updateDealField('stage',this.value)">
              ${stages.map(s=>`<option value="${esc(s.id)}" ${deal.stage===s.id?'selected':''}>${esc(s.label)}</option>`).join("")}
            </select>
          </div>
        </div>
        <div class="form-group form-span2" style="margin-bottom:16px">
          <label>Notes</label>
          <textarea id="deal-notes" rows="2" oninput="updateDealField('notes',this.value)">${esc(deal.notes||'')}</textarea>
        </div>`;

  if(deal.campaignName){
    h+=`<div class="sl-info">
      <div class="sl-info-title">Smartlead Source</div>
      <div>Campaign: ${esc(deal.campaignName)}</div>
      ${deal.leadCategory?`<div>Category: ${esc(deal.leadCategory)}</div>`:''}
      ${deal.smartleadUrl?`<a href="${esc(deal.smartleadUrl)}" target="_blank" rel="noopener">Open in Smartlead ‚Üí</a>`:''}
    </div>`;
  }

  // Reply preview ‚Äî show in ALL pipelines
  const replyText=str(deal.emailBody||'').trim();
  if(replyText){
    const catClass=str(deal.leadCategory||'').toLowerCase().includes('interested')?'cat-interested':
      str(deal.leadCategory||'').toLowerCase().includes('meeting')?'cat-meeting':'cat-info';
    h+=`<div class="reply-preview">
      <div class="reply-preview-title">üì® Their Reply <span class="reply-preview-category ${catClass}">${esc(deal.leadCategory||'')}</span></div>
      <div class="reply-preview-body">${esc(replyText)}</div>
    </div>`;
  }

  // Client Action Buttons ‚Äî CLIENT PIPELINE ONLY
  if(deal.pipeline==='Client'){
    // Find matched client for this deal (by campaign keyword OR by stage name)
    const matchedClient=findClientForDeal(deal) || state.clients.find(c=>c.name===deal.stage);

    if(matchedClient){
      const isOn=(field)=>str(matchedClient[field]).toUpperCase()==='TRUE';

      // Forward Lead Email button
      if(isOn('enableForward')){
        const forwarded=deal.forwardedAt && str(deal.forwardedAt).trim()!=='';
        const fwdLabel=forwarded
          ? '‚úÖ Forwarded to '+esc(matchedClient.name)+' ‚Äî '+new Date(deal.forwardedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})
          : 'üìß Forward Lead to '+esc(matchedClient.name);
        h+=`<div style="margin:0 0 8px 0">
          <button class="btn forward-btn ${forwarded?'sent':'ready'}" 
            onclick="${forwarded?'':'forwardDealToClient(\''+deal.id+'\')'}" ${forwarded?'disabled':''}>
            ${fwdLabel}
          </button>
        </div>`;
      }

      // Book Meeting via Calendly button
      if(isOn('enableCalendly') && matchedClient.calendlyUrl){
        const calUrl=buildCalendlyUrl(matchedClient.calendlyUrl, deal);
        h+=`<div style="margin:0 0 8px 0">
          <a href="${esc(calUrl)}" target="_blank" rel="noopener" class="btn btn-primary" 
            style="width:100%;justify-content:center;gap:6px;font-size:13px;text-decoration:none;display:flex;background:#818cf8;border-color:#818cf8"
            onclick="event.stopPropagation()">
            üìÖ Book Meeting on ${esc(matchedClient.name)}'s Calendar
          </a>
        </div>`;
      }

      // Copy Lead Info button
      if(isOn('enableCopyInfo')){
        h+=`<div style="margin:0 0 8px 0">
          <button class="btn btn-ghost" style="width:100%;justify-content:center;gap:6px;font-size:13px"
            onclick="copyLeadInfo('${esc(deal.id)}')">
            üìã Copy Lead Info for ${esc(matchedClient.name)}
          </button>
        </div>`;
      }

      // Push to Lead Tracker button
      if(isOn('enableTracker')){
        const pushed=deal.pushedToTracker;
        h+=`<div style="margin:0 0 8px 0">
          <button class="btn ${pushed?'btn-ghost':'btn-primary'}" style="width:100%;justify-content:center;gap:6px;font-size:13px" 
            onclick="${pushed?'':'pushToLeadTracker(\''+deal.id+'\')'}" ${pushed?'disabled':''}>
            ${pushed?'‚úÖ Pushed to Lead Tracker':'üì§ Push to Lead Tracker'}
          </button>
        </div>`;
      }

      // Show warning if no actions are enabled
      if(!isOn('enableForward') && !isOn('enableCalendly') && !isOn('enableCopyInfo') && !isOn('enableTracker')){
        h+=`<div style="margin:0 0 12px 0;padding:8px 12px;background:#fef3c7;border:1px solid #fde68a;border-radius:var(--radius);font-size:11px;color:#92400e">
          ‚ö†Ô∏è No actions enabled for ${esc(matchedClient.name)}. Configure in Settings ‚Üí Clients.
        </div>`;
      }
    } else if(deal.campaignName){
      h+=`<div style="margin:0 0 12px 0;padding:8px 12px;background:#fef3c7;border:1px solid #fde68a;border-radius:var(--radius);font-size:11px;color:#92400e">
        ‚ö†Ô∏è No client matched for this campaign. Add campaign keywords in Settings ‚Üí Clients.
      </div>`;
    }
  }

  // ACQUISITION PIPELINE ‚Äî Book Discovery Call button
  if(deal.pipeline==='Acquisition'){
    const discCalUrl=buildCalendlyUrl('https://calendly.com/aidan-theheadlinetheory/discovery-call-with-the-headline-theory-clone', deal);
    h+=`<div style="margin:0 0 8px 0">
      <a href="${esc(discCalUrl)}" target="_blank" rel="noopener" class="btn btn-primary" 
        style="width:100%;justify-content:center;gap:6px;font-size:13px;text-decoration:none;display:flex;background:#2563eb;border-color:#2563eb"
        onclick="event.stopPropagation()">
        üìÖ Book Discovery Call
      </a>
    </div>`;
  }

  // Activities section
  h+=`<div class="activities-section">
    <div class="activities-header">
      <h4>Activities</h4>
      <button class="sop-btn ${state.showSop?'active':''}" onclick="state.showSop=!state.showSop;refreshModal()">üìã Assign SOP Day</button>
    </div>`;

  if(state.showSop){
    const sopDays=getSopDays(deal);
    h+=`<div class="sop-grid">
      <div style="width:100%;margin-bottom:8px;display:flex;align-items:center;gap:8px">
        <label style="font-size:11px;font-weight:600;color:#6b7280">Date:</label>
        <input type="date" id="sop-target-date" value="${TODAY()}" style="padding:4px 8px;border:1px solid #d8b4fe;border-radius:6px;font-size:12px;font-family:inherit">
        <span style="font-size:10px;color:#a78bfa">${deal.pipeline==='Client'?'Client SOP':'Acquisition SOP'}</span>
      </div>
      ${Object.entries(sopDays).map(([day,acts])=>`
      <button class="sop-day-btn" onclick="doAssignSequenceWithDate('${deal.id}','${day}')">${day} <span style="font-weight:400;color:#a78bfa">(${acts.length})</span></button>`).join("")}</div>`;
  }

  h+=`<div class="add-act-row">
    <select id="new-act-type">${ACTIVITY_TYPES.map(t=>`<option value="${t}">${ACTIVITY_ICONS[t]||""} ${t}</option>`).join("")}</select>
    <input id="new-act-subject" placeholder="Subject" style="flex:1">
    <input id="new-act-date" type="date" value="${TODAY()}">
    <button class="btn btn-primary" onclick="doAddActivity('${deal.id}')">+ Add</button>
  </div>`;

  // Pending
  for(const a of pending){
    const dd=(a.dueDate||'').slice(0,10);
    const today=getToday();
    const overdue=dd&&dd<today;
    const dueToday=dd===today;
    const cls=overdue?'overdue':dueToday?'today':'future';
    const createdStr=a.createdDate?'<span style="font-size:9px;color:#b0b0b0;margin-left:4px" title="Created '+fmtTimestamp(a.createdDate)+'">'+fmtTimestamp(a.createdDate)+'</span>':'';
    h+=`<div class="act-item ${cls}">
      <input type="checkbox" onchange="toggleActivity('${a.id}')">
      <span style="font-size:13px">${ACTIVITY_ICONS[a.type]||"‚úì"}</span>
      <span class="act-subject">${esc(a.subject||a.type)}</span>
      ${a.dayLabel?`<span class="act-day-label">${esc(a.dayLabel)}</span>`:''}
      ${a.dueDate?`<input type="date" value="${dd}" style="font-size:10px;color:${overdue?'#ef4444':dueToday?'#059669':'#9ca3af'};background:none;border:none;cursor:pointer;padding:0;width:90px" onchange="updateActivityDate('${a.id}',this.value)">`:''}
      <button class="act-delete" onclick="deleteActivity('${a.id}')">√ó</button>
    </div>
    ${createdStr?'<div style="padding-left:28px;margin-top:-4px;margin-bottom:4px">'+createdStr+'</div>':''}`;
  }

  // Completed
  if(completed.length){
    h+=`<details style="margin-top:8px"><summary class="completed-toggle">Completed (${completed.length})</summary>`;
    for(const a of completed){
      const completedStr=a.completedAt?'<span style="font-size:9px;color:#22c55e;margin-left:6px">‚úì '+fmtTimestamp(a.completedAt)+'</span>':'';
      h+=`<div class="completed-item">
        <input type="checkbox" checked onchange="toggleActivity('${a.id}')">
        <span style="font-size:13px">${ACTIVITY_ICONS[a.type]||"‚úì"}</span>
        <span class="act-subject">${esc(a.subject||a.type)}${completedStr}</span>
      </div>`;
    }
    h+=`</details>`;
  }

  if(!pending.length&&!completed.length) h+=`<div class="no-activities">No activities yet</div>`;

  h+=`</div></div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="if(confirm('Delete this deal?'))deleteDeal('${deal.id}')">Delete</button>
      <div style="display:flex;gap:8px">
        <button class="btn" style="background:#f9fafb;color:#6b7280;border:1px solid #e5e7eb" onclick="closeDealModal()">Cancel</button>
        <button class="btn btn-primary" onclick="doSaveDeal('${deal.id}')">Save</button>
      </div>
    </div></div></div>`;
  return h;
}

function renderNewDealModal(stages){
  const defVal=state.pipeline==="acquisition"?1057:0;
  return`<div class="modal-overlay" onclick="state.showNew=false;render()">
    <div class="modal" style="width:440px" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>New Deal</h3><button class="modal-close" onclick="state.showNew=false;render()">√ó</button></div>
      <div class="modal-body">
        <div class="form-grid">
          ${["company:Company","contact:Contact Name","email:Email","phone:Phone","website:Website"].map(f=>{
            const[k,label]=f.split(":");
            return`<div class="form-group"><label>${label}</label><input id="new-${k}"></div>`;
          }).join("")}
          <div class="form-group"><label>Deal Value ($)</label><input id="new-value" type="number" value="${defVal}"></div>
          <div class="form-group form-span2">
            <label>Stage</label>
            <select id="new-stage">${stages.map(s=>`<option value="${esc(s.id)}">${esc(s.label)}</option>`).join("")}</select>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:flex-end">
        <button class="btn" style="background:#f9fafb;color:#6b7280;border:1px solid #e5e7eb" onclick="state.showNew=false;render()">Cancel</button>
        <button class="btn btn-primary" onclick="doCreateDeal()">Create Deal</button>
      </div>
    </div></div>`;
}

function renderAddClientModal(){
  return`<div class="modal-overlay" onclick="state.showAddClient=false;render()">
    <div class="modal" style="width:340px" onclick="event.stopPropagation()">
      <div style="padding:20px">
        <h3 style="margin:0 0 12px;font-size:16px;font-weight:800">Add Client</h3>
        <input id="new-client-name" placeholder="Client name" style="width:100%;padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;box-sizing:border-box;outline:none;margin-bottom:12px"
          onkeydown="if(event.key==='Enter'){doAddClient()}">
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" style="background:#f9fafb;color:#6b7280;border:1px solid #e5e7eb" onclick="state.showAddClient=false;render()">Cancel</button>
          <button class="btn btn-primary" onclick="doAddClient()">Add</button>
        </div>
      </div>
    </div></div>`;
}

// ‚îÄ‚îÄ‚îÄ Event Handlers ‚îÄ‚îÄ‚îÄ
function openDeal(id){
  const sid=String(id);
  state.selectedDeal=state.deals.find(d=>String(d.id)===sid);
  state.showSop=false;
  render();
}

function closeDealModal(){
  state.selectedDeal=null;
  state.showSop=false;
  render();
}

function openNewDeal(){ state.showNew=true; render(); }
function openAddClient(){ state.showAddClient=true; render(); }

function changeDealPipeline(newPipeline){
  if(!state.selectedDeal) return;
  state.selectedDeal.pipeline = newPipeline;
  // Determine appropriate stages for new pipeline
  var newStages;
  if(newPipeline==='Acquisition') newStages = ACQUISITION_STAGES;
  else if(newPipeline==='Nurture') newStages = NURTURE_STAGES;
  else newStages = state.clients.map(c=>({id:c.name,label:c.name,color:c.color||'#6366f1'}));
  // Set stage to first stage of new pipeline
  state.selectedDeal.stage = newStages.length ? newStages[0].id : 'Cold Email Response';
  // Re-render the stage dropdown
  var sel = document.getElementById('deal-stage');
  if(sel){
    sel.innerHTML = newStages.map(s=>'<option value="'+esc(s.id)+'" '+(state.selectedDeal.stage===s.id?'selected':'')+'>'+esc(s.label)+'</option>').join('');
  }
}

function updateDealField(key,val){
  if(state.selectedDeal){
    if(key==="value") val=Number(val)||0;
    state.selectedDeal[key]=val;
  }
}

function doSaveDeal(id){
  const deal=state.selectedDeal;
  if(!deal)return;
  // Grab latest values from form inputs
  ["company","contact","email","phone","website","location","address","notes"].forEach(k=>{
    const el=document.getElementById("deal-"+k);
    if(el) deal[k]=el.value;
  });
  const valEl=document.getElementById("deal-value");
  if(valEl) deal.value=Number(valEl.value)||0;
  const stageEl=document.getElementById("deal-stage");
  if(stageEl) deal.stage=stageEl.value;
  const pipEl=document.getElementById("deal-pipeline");
  if(pipEl) deal.pipeline=pipEl.value;
  saveDeal(deal);
}

function doCreateDeal(){
  const form={};
  ["company","contact","email","phone","website"].forEach(k=>{
    const el=document.getElementById("new-"+k);
    form[k]=el?el.value:"";
  });
  const valEl=document.getElementById("new-value");
  form.value=valEl?Number(valEl.value)||0:0;
  const stageEl=document.getElementById("new-stage");
  form.stage=stageEl?stageEl.value:getStages()[0]?.id||"";
  form.notes="";
  state.showNew=false;
  createDeal(form);
}

function doAddClient(){
  const el=document.getElementById("new-client-name");
  const name=el?el.value.trim():"";
  if(!name)return;
  state.showAddClient=false;
  addClient(name);
}

function doAddActivity(dealId){
  const type=document.getElementById("new-act-type")?.value||"Call";
  const subject=document.getElementById("new-act-subject")?.value||"";
  const dueDate=document.getElementById("new-act-date")?.value||TODAY();
  addActivity(dealId,{type,subject:subject||type,dueDate});
  const subEl=document.getElementById("new-act-subject");
  if(subEl) subEl.value="";
}

// Format 24h time to 12h AM/PM
function fmtTime12(t){
  if(!t) return '';
  const [h,m]=t.split(':').map(Number);
  const ampm=h>=12?'PM':'AM';
  const h12=h%12||12;
  return h12+':'+String(m).padStart(2,'0')+' '+ampm;
}

// Format ISO timestamp to readable local time
function fmtTimestamp(iso){
  if(!iso) return '';
  try{
    const d=new Date(iso);
    if(isNaN(d.getTime())) return '';
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()]+' '+d.getDate()+' '+fmtTime12(d.getHours()+':'+String(d.getMinutes()).padStart(2,'0'));
  }catch(e){return '';}
}

function doAssignSequence(dealId,day){
  const deal=state.deals.find(d=>d.id===dealId);
  const sopDays=getSopDays(deal);
  const acts=sopDays[day];
  if(!acts) return;
  const dateInput = prompt('Schedule "' + day + '" activities for which date?\n\nFormat: YYYY-MM-DD (e.g. ' + TODAY() + ')', TODAY());
  if(!dateInput) return;
  const dateMatch = dateInput.match(/^\d{4}-\d{2}-\d{2}$/);
  if(!dateMatch){ alert('Invalid date format. Use YYYY-MM-DD.'); return; }
  assignSequence(dealId,day,acts,dateInput);
  state.showSop=false;
}

function doAssignSequenceWithDate(dealId,day){
  const deal=state.deals.find(d=>d.id===dealId);
  const sopDays=getSopDays(deal);
  const acts=sopDays[day];
  if(!acts) return;
  const dateEl=document.getElementById('sop-target-date');
  const targetDate=dateEl?dateEl.value:TODAY();
  if(!targetDate.match(/^\d{4}-\d{2}-\d{2}$/)){ alert('Please select a valid date.'); return; }
  assignSequence(dealId,day,acts,targetDate);
  state.showSop=false;
}

function doDragOver(colEl){
  colEl.querySelector('.col-header').classList.add('drag-over');
  colEl.querySelector('.col-body').classList.add('drag-over');
}
function doDragLeave(evt,colEl){
  if(colEl.contains(evt.relatedTarget))return;
  colEl.querySelector('.col-header').classList.remove('drag-over');
  colEl.querySelector('.col-body').classList.remove('drag-over');
}
function clearAllDragOver(){
  document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
}
function doDrop(stageKey){
  clearAllDragOver();
  hideDeleteZone();
  const stageId=decodeURIComponent(escape(atob(stageKey)));
  if(state.dragId){moveDeal(state.dragId,stageId);}
  state.dragId=null;
}

function showDeleteZone(){
  const z=document.getElementById('delete-zone');
  if(z) z.classList.add('visible');
}
function hideDeleteZone(){
  const z=document.getElementById('delete-zone');
  if(z){ z.classList.remove('visible'); z.classList.remove('drag-hover'); }
}
function doLostDrop(){
  hideDeleteZone();
  clearAllDragOver();
  if(state.dragId){
    const deal=state.deals.find(d=>d.id===state.dragId);
    const name=deal?(deal.company||deal.contact||'this deal'):'this deal';
    if(confirm('Mark "'+name+'" as Lost and delete? This cannot be undone.')){
      deleteDeal(state.dragId);
    }
  }
  state.dragId=null;
}

async function doWonDrop(){
  hideDeleteZone();
  clearAllDragOver();
  if(state.dragId){
    const deal=state.deals.find(d=>d.id===state.dragId);
    if(!deal){ state.dragId=null; return; }
    // Only allow Won/Push for client pipeline deals
    if(deal.pipeline!=='Client'){
      alert('Won ‚Üí Push to Tracker is only available for Client pipeline deals. Use Lost/Delete for acquisition deals.');
      state.dragId=null; return;
    }
    const name=deal.company||deal.contact||'this deal';
    if(confirm('Mark "'+name+'" as Won, push to Lead Tracker, and remove from CRM?')){
      // Get cost
      const client=findClientForDeal(deal) || state.clients.find(c=>c.name===deal.stage);
      let leadCost='';
      if(client && str(client.leadCost).replace(/[^0-9.]/g,'')){
        leadCost='$'+str(client.leadCost).replace(/[^0-9.]/g,'');
      } else {
        const costInput=prompt('Enter lead cost for this client (e.g. 200, 250):','250');
        if(costInput===null){ state.dragId=null; return; }
        const costNum=parseFloat(costInput.replace(/[^0-9.]/g,''));
        if(isNaN(costNum)){alert('Invalid cost. Please enter a number.'); state.dragId=null; return;}
        leadCost='$'+costNum;
      }
      const now=new Date();
      const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
      const monthGenerated=monthNames[now.getMonth()]+'/'+String(now.getFullYear()).slice(2);
      const dateGenerated=(now.getMonth()+1)+'/'+now.getDate()+'/'+String(now.getFullYear()).slice(2);
      const clientName=client?client.name:deal.stage;
      const leadName=deal.company||deal.contact||'Unknown';
      const leadEmail=deal.email||'';
      const row=[clientName,monthGenerated,leadName,leadEmail,dateGenerated,leadCost,'','','',''];
      try{
        await apiPost('push_lead_tracker',{sheetId:LEAD_TRACKER_SHEET_ID,sheetName:'Lead Tracker',row});
        alert('\u2705 Pushed "'+leadName+'" to Lead Tracker at '+leadCost);
        deleteDeal(state.dragId);
      }catch(e){
        alert('\u274c Failed to push to Lead Tracker: '+e.message);
      }
    }
  }
  state.dragId=null;
}

function toggleBadgeDropdown(dealId){
  // Close all other dropdowns first
  document.querySelectorAll(".badge-dropdown").forEach(el=>{
    if(el.id!=="badge-"+dealId) el.style.display="none";
  });
  document.querySelectorAll(".deal-card.badge-open").forEach(el=>el.classList.remove("badge-open"));
  const el=document.getElementById("badge-"+dealId);
  if(el){
    const show=el.style.display==="none";
    el.style.display=show?"block":"none";
    if(show){
      const card=el.closest(".deal-card");
      if(card) card.classList.add("badge-open");
    }
  }
}

// Close badge dropdowns on outside click
document.addEventListener("click",function(e){
  if(!e.target.closest(".activity-badge")&&!e.target.closest(".status-indicator")){
    document.querySelectorAll(".badge-dropdown").forEach(el=>el.style.display="none");
    document.querySelectorAll(".deal-card.badge-open").forEach(el=>el.classList.remove("badge-open"));
  }
  if(!e.target.closest('.search-wrapper')&&state.searchResults!==null){clearSearch();}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getDefaultSettings(){
  return {
    acquisition_stages: ACQUISITION_STAGES.map((s,i)=>({...s,order:i})),
    nurture_stages: NURTURE_STAGES.map((s,i)=>({...s,order:i})),
    activity_types: ACTIVITY_TYPES.map((t,i)=>({name:t,icon:ACTIVITY_ICONS[t]||"‚úì",order:i})),
    sop_acquisition: Object.entries(SOP_DAYS).map(([day,acts])=>({name:day,activities:acts})),
    sop_client: Object.entries(CLIENT_SOP_DAYS).map(([day,acts])=>({name:day,activities:acts})),
  };
}

function openSettings(){
  settingsDraft = getDefaultSettings();
  // Merge saved settings if available
  if(state.savedSettings){
    for(const k of Object.keys(settingsDraft)){
      if(state.savedSettings[k]) settingsDraft[k] = JSON.parse(JSON.stringify(state.savedSettings[k]));
    }
  }
  settingsOpen = true;
  renderSettingsPanel();
}

function closeSettings(){
  settingsOpen = false;
  const overlay = document.getElementById('settings-overlay');
  const panel = document.getElementById('settings-panel');
  if(overlay) overlay.classList.remove('open');
  if(panel) panel.classList.remove('open');
  setTimeout(()=>{
    if(overlay) overlay.remove();
    if(panel) panel.remove();
  }, 250);
}

function renderSettingsPanel(){
  const existingPanel = document.getElementById('settings-panel');
  const existingOverlay = document.getElementById('settings-overlay');
  
  // Save scroll position before re-render
  let savedScroll = 0;
  if(existingPanel){
    const body = existingPanel.querySelector('.settings-body');
    if(body) savedScroll = body.scrollTop;
  }

  // Remove existing
  if(existingOverlay) existingOverlay.remove();
  if(existingPanel) existingPanel.remove();
  
  const overlay = document.createElement('div');
  overlay.id='settings-overlay';
  overlay.className='settings-overlay';
  overlay.onclick=closeSettings;
  document.body.appendChild(overlay);

  const panel = document.createElement('div');
  panel.id='settings-panel';
  panel.className='settings-panel';
  panel.onclick=e=>e.stopPropagation();

  let h=`<div class="settings-header">
    <h3>‚öôÔ∏è Settings</h3>
    <button class="modal-close" onclick="closeSettings()">√ó</button>
  </div>
  <div class="settings-tab-bar">
    <button class="settings-tab ${settingsTab==='stages'?'active':''}" onclick="settingsTab='stages';renderSettingsPanel()">Pipeline Stages</button>
    <button class="settings-tab ${settingsTab==='activities'?'active':''}" onclick="settingsTab='activities';renderSettingsPanel()">Activity Types</button>
    <button class="settings-tab ${settingsTab==='sop'?'active':''}" onclick="settingsTab='sop';renderSettingsPanel()">SOP Sequences</button>
    <button class="settings-tab ${settingsTab==='clients'?'active':''}" onclick="settingsTab='clients';renderSettingsPanel()">Clients</button>
  </div>
  <div class="settings-body">`;

  if(settingsTab==='stages') h+=renderStagesSettings();
  else if(settingsTab==='activities') h+=renderActivityTypesSettings();
  else if(settingsTab==='sop') h+=renderSopSettings();
  else if(settingsTab==='clients') h+=renderClientsSettings();

  h+=`</div>
  <div class="settings-footer">
    <button class="btn" style="background:#f9fafb;color:#6b7280;border:1px solid #e5e7eb" onclick="closeSettings()">Cancel</button>
    <button class="btn btn-primary" onclick="saveSettingsToSheet()">üíæ Save Settings</button>
    <span id="settings-autosave-status" style="font-size:10px;color:#9ca3af;align-self:center;margin-left:8px"></span>
  </div>`;

  panel.innerHTML=h;
  document.body.appendChild(panel);

  // Restore scroll position
  if(savedScroll > 0){
    const body = panel.querySelector('.settings-body');
    if(body) body.scrollTop = savedScroll;
  }

  // Animate open
  requestAnimationFrame(()=>{
    overlay.classList.add('open');
    panel.classList.add('open');
  });

  // Setup drag-and-drop for lists
  setupSettingsDrag();
}

function renderStagesSettings(){
  let h='';
  // Acquisition stages
  h+=`<div class="settings-section">
    <h4>üìä Acquisition Pipeline Stages</h4>
    <div class="settings-list" id="settings-acq-stages" data-key="acquisition_stages">`;
  for(const [i,s] of settingsDraft.acquisition_stages.entries()){
    h+=`<div class="settings-list-item" draggable="true" data-idx="${i}">
      <span class="drag-handle">‚†ø</span>
      <input type="color" class="item-color" value="${s.color}" onchange="settingsDraft.acquisition_stages[${i}].color=this.value;debouncedAutoSave()" style="width:24px;height:24px;border:none;padding:0;cursor:pointer;background:none">
      <input class="item-label" value="${esc(s.label)}" oninput="settingsDraft.acquisition_stages[${i}].label=this.value;settingsDraft.acquisition_stages[${i}].id=this.value;debouncedAutoSave()" style="border:none;background:transparent;font-size:12px;font-weight:500;font-family:var(--font);flex:1">
      <button class="item-delete" onclick="settingsDraft.acquisition_stages.splice(${i},1);renderSettingsPanel();debouncedAutoSave()">√ó</button>
    </div>`;
  }
  h+=`</div>
    <div class="settings-add-row">
      <input id="new-acq-stage" placeholder="New stage name...">
      <button class="btn btn-primary" onclick="addSettingsStage('acquisition_stages','new-acq-stage')">+ Add</button>
    </div>
  </div>`;

  // Nurture stages
  h+=`<div class="settings-section">
    <h4>üå± Nurture Pipeline Stages</h4>
    <div class="settings-list" id="settings-nurt-stages" data-key="nurture_stages">`;
  for(const [i,s] of settingsDraft.nurture_stages.entries()){
    h+=`<div class="settings-list-item" draggable="true" data-idx="${i}">
      <span class="drag-handle">‚†ø</span>
      <input type="color" class="item-color" value="${s.color}" onchange="settingsDraft.nurture_stages[${i}].color=this.value;debouncedAutoSave()" style="width:24px;height:24px;border:none;padding:0;cursor:pointer;background:none">
      <input class="item-label" value="${esc(s.label)}" oninput="settingsDraft.nurture_stages[${i}].label=this.value;settingsDraft.nurture_stages[${i}].id=this.value;debouncedAutoSave()" style="border:none;background:transparent;font-size:12px;font-weight:500;font-family:var(--font);flex:1">
      <button class="item-delete" onclick="settingsDraft.nurture_stages.splice(${i},1);renderSettingsPanel();debouncedAutoSave()">√ó</button>
    </div>`;
  }
  h+=`</div>
    <div class="settings-add-row">
      <input id="new-nurt-stage" placeholder="New stage name...">
      <button class="btn btn-primary" onclick="addSettingsStage('nurture_stages','new-nurt-stage')">+ Add</button>
    </div>
  </div>`;

  h+=`<p style="font-size:11px;color:var(--text-muted);margin-top:8px">‚ÑπÔ∏è Client Leads stages are managed via the + Client button. Drag stages to reorder.</p>`;
  return h;
}

function renderActivityTypesSettings(){
  let h=`<div class="settings-section">
    <h4>üìã Activity Types</h4>
    <div class="settings-list" id="settings-act-types" data-key="activity_types">`;
  for(const [i,t] of settingsDraft.activity_types.entries()){
    h+=`<div class="settings-list-item" draggable="true" data-idx="${i}">
      <span class="drag-handle">‚†ø</span>
      <input value="${esc(t.icon)}" oninput="settingsDraft.activity_types[${i}].icon=this.value;debouncedAutoSave()" style="width:32px;text-align:center;border:1px solid var(--border);border-radius:4px;font-size:14px;padding:2px">
      <input class="item-label" value="${esc(t.name)}" oninput="settingsDraft.activity_types[${i}].name=this.value;debouncedAutoSave()" style="border:none;background:transparent;font-size:12px;font-weight:500;font-family:var(--font);flex:1">
      <button class="item-delete" onclick="settingsDraft.activity_types.splice(${i},1);renderSettingsPanel();debouncedAutoSave()">√ó</button>
    </div>`;
  }
  h+=`</div>
    <div class="settings-add-row">
      <input id="new-act-icon" placeholder="Icon" style="width:50px;text-align:center">
      <input id="new-act-name" placeholder="Activity type name...">
      <button class="btn btn-primary" onclick="addSettingsActivityType()">+ Add</button>
    </div>
  </div>`;
  return h;
}

function renderSopSettings(){
  let h='';
  // Acquisition SOPs
  h+=`<div class="settings-section">
    <h4>üìä Acquisition SOP Sequences</h4>`;
  for(const [i,seq] of settingsDraft.sop_acquisition.entries()){
    h+=renderSopSequence('sop_acquisition',i,seq);
  }
  h+=`<div class="settings-add-row" style="margin-top:8px">
    <input id="new-acq-sop-name" placeholder="Sequence name (e.g. Day 11)...">
    <button class="btn btn-primary" onclick="addSopSequence('sop_acquisition','new-acq-sop-name')">+ Add Sequence</button>
  </div></div>`;

  // Client SOPs
  h+=`<div class="settings-section">
    <h4>üë• Client SOP Sequences</h4>`;
  for(const [i,seq] of settingsDraft.sop_client.entries()){
    h+=renderSopSequence('sop_client',i,seq);
  }
  h+=`<div class="settings-add-row" style="margin-top:8px">
    <input id="new-cli-sop-name" placeholder="Sequence name...">
    <button class="btn btn-primary" onclick="addSopSequence('sop_client','new-cli-sop-name')">+ Add Sequence</button>
  </div></div>`;
  return h;
}

function renderSopSequence(key,idx,seq){
  const actTypes = settingsDraft.activity_types.map(t=>t.name);
  let h=`<div class="sop-sequence">
    <div class="sop-sequence-header">
      <input value="${esc(seq.name)}" oninput="settingsDraft.${key}[${idx}].name=this.value;debouncedAutoSave()" style="border:none;background:transparent;font-size:12px;font-weight:700;color:var(--purple);font-family:var(--font);width:120px">
      <div style="display:flex;gap:4px">
        <button class="btn" style="font-size:10px;padding:2px 8px;background:#f0fdf4;color:#059669;border:1px solid #bbf7d0" onclick="addSopActivity('${key}',${idx})">+ Activity</button>
        <button class="item-delete" onclick="settingsDraft.${key}.splice(${idx},1);renderSettingsPanel();debouncedAutoSave()" style="font-size:16px">√ó</button>
      </div>
    </div>`;
  for(const [j,act] of seq.activities.entries()){
    h+=`<div class="sop-act-item">
      <select onchange="settingsDraft.${key}[${idx}].activities[${j}].type=this.value;debouncedAutoSave()">
        ${actTypes.map(t=>`<option value="${t}" ${t===act.type?'selected':''}>${t}</option>`).join('')}
      </select>
      <input value="${esc(act.subject)}" oninput="settingsDraft.${key}[${idx}].activities[${j}].subject=this.value;debouncedAutoSave()">
      <button class="item-delete" onclick="settingsDraft.${key}[${idx}].activities.splice(${j},1);renderSettingsPanel();debouncedAutoSave()">√ó</button>
    </div>`;
  }
  h+=`</div>`;
  return h;
}

function addSettingsStage(key,inputId){
  const el=document.getElementById(inputId);
  const name=(el?el.value:'').trim();
  if(!name) return;
  const colors=['#7c3aed','#6366f1','#2563eb','#0891b2','#059669','#d97706','#ef4444','#8b5cf6','#f97316','#10b981'];
  settingsDraft[key].push({id:name,label:name,color:colors[settingsDraft[key].length%colors.length],order:settingsDraft[key].length});
  renderSettingsPanel();
  debouncedAutoSave();
}

function addSettingsActivityType(){
  const iconEl=document.getElementById('new-act-icon');
  const nameEl=document.getElementById('new-act-name');
  const icon=(iconEl?iconEl.value:'').trim()||'‚úì';
  const name=(nameEl?nameEl.value:'').trim();
  if(!name) return;
  settingsDraft.activity_types.push({name,icon,order:settingsDraft.activity_types.length});
  renderSettingsPanel();
  debouncedAutoSave();
}

function addSopSequence(key,inputId){
  const el=document.getElementById(inputId);
  const name=(el?el.value:'').trim();
  if(!name) return;
  settingsDraft[key].push({name,activities:[{type:'Email',subject:'Email'},{type:'Call',subject:'Call'}]});
  renderSettingsPanel();
  debouncedAutoSave();
}

function addSopActivity(key,idx){
  settingsDraft[key][idx].activities.push({type:'Call',subject:'Activity'});
  renderSettingsPanel();
  debouncedAutoSave();
}

// Auto-save: debounce to avoid hammering the API on every keystroke
let _autoSaveTimer = null;
function debouncedAutoSave(){
  clearTimeout(_autoSaveTimer);
  const statusEl = document.getElementById('settings-autosave-status');
  if(statusEl) statusEl.textContent = 'Unsaved changes...';
  _autoSaveTimer = setTimeout(async ()=>{
    try{
      applySettings(settingsDraft);
      const clientUpdates = state.clients.filter(c=>c.id).map(c=>({
        id:c.id,
        notifyEmails:str(c.notifyEmails),
        campaignKeywords:str(c.campaignKeywords),
        calendlyUrl:str(c.calendlyUrl),
        enableForward:str(c.enableForward),
        enableCalendly:str(c.enableCalendly),
        enableCopyInfo:str(c.enableCopyInfo),
        enableTracker:str(c.enableTracker),
        leadCost:str(c.leadCost)
      }));
      await Promise.all([
        apiPost('save_settings',{settings:settingsDraft}),
        apiPost('batch_update_clients',{clients:clientUpdates})
      ]);
      const s = document.getElementById('settings-autosave-status');
      if(s) s.textContent = '‚úì Auto-saved';
      setTimeout(()=>{ const s2=document.getElementById('settings-autosave-status'); if(s2 && s2.textContent==='‚úì Auto-saved') s2.textContent=''; }, 2000);
    }catch(e){
      const s = document.getElementById('settings-autosave-status');
      if(s) s.textContent = '‚ö† Save failed';
    }
  }, 1500);
}

function setupSettingsDrag(){
  document.querySelectorAll('.settings-list').forEach(list=>{
    const key=list.dataset.key;
    let dragIdx=null;
    list.querySelectorAll('.settings-list-item').forEach(item=>{
      item.addEventListener('dragstart',e=>{
        dragIdx=parseInt(item.dataset.idx);
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed='move';
      });
      item.addEventListener('dragend',()=>{
        item.classList.remove('dragging');
        dragIdx=null;
      });
      item.addEventListener('dragover',e=>{
        e.preventDefault();
        e.dataTransfer.dropEffect='move';
      });
      item.addEventListener('drop',e=>{
        e.preventDefault();
        const dropIdx=parseInt(item.dataset.idx);
        if(dragIdx!==null && dragIdx!==dropIdx && settingsDraft[key]){
          const arr=settingsDraft[key];
          const [moved]=arr.splice(dragIdx,1);
          arr.splice(dropIdx,0,moved);
          renderSettingsPanel();
        }
      });
    });
  });
}

function applySettings(s){
  state.savedSettings = s;
  // Apply stages
  if(s.acquisition_stages){
    ACQUISITION_STAGES.length=0;
    s.acquisition_stages.forEach(st=>ACQUISITION_STAGES.push({id:st.id||st.label,label:st.label,color:st.color}));
  }
  if(s.nurture_stages){
    NURTURE_STAGES.length=0;
    s.nurture_stages.forEach(st=>NURTURE_STAGES.push({id:st.id||st.label,label:st.label,color:st.color}));
  }
  // Apply activity types
  if(s.activity_types){
    ACTIVITY_TYPES.length=0;
    s.activity_types.forEach(t=>{
      ACTIVITY_TYPES.push(t.name);
      ACTIVITY_ICONS[t.name]=t.icon||'‚úì';
    });
  }
  // Apply SOP sequences
  if(s.sop_acquisition){
    // Clear and rebuild SOP_DAYS
    Object.keys(SOP_DAYS).forEach(k=>delete SOP_DAYS[k]);
    s.sop_acquisition.forEach(seq=>{
      SOP_DAYS[seq.name]=seq.activities.map(a=>({type:a.type,subject:a.subject}));
    });
  }
  if(s.sop_client){
    Object.keys(CLIENT_SOP_DAYS).forEach(k=>delete CLIENT_SOP_DAYS[k]);
    s.sop_client.forEach(seq=>{
      CLIENT_SOP_DAYS[seq.name]=seq.activities.map(a=>({type:a.type,subject:a.subject}));
    });
  }
  // Apply client Calendly URLs
  if(s.clientCalendlyUrls){
    try{
      const urls=typeof s.clientCalendlyUrls==='string'?JSON.parse(s.clientCalendlyUrls):s.clientCalendlyUrls;
      if(Array.isArray(urls)){
        for(const u of urls){
          const c=state.clients.find(x=>x.name===u.name);
          if(c){ if(u.calendlyUrl) c.calendlyUrl=u.calendlyUrl; if(u.color) c.color=u.color; }
        }
      }
    }catch(e){}
  }
}

function renderClientsSettings(){
  let h=`<div style="padding:16px 0">
    <h4 style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px">Client Configuration</h4>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px">Set up how each client's leads are handled. Toggle actions on/off and fill in the details.</p>`;

  if(state.clients.length===0){
    h+=`<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">No clients added yet.</p></div>`;
    return h;
  }

  for(const c of state.clients){
    const isOn=(field)=>str(c[field]).toUpperCase()==='TRUE';
    h+=`<div style="margin-bottom:16px;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="width:12px;height:12px;border-radius:50%;background:${c.color||'#818cf8'};flex-shrink:0"></span>
        <span style="font-size:14px;font-weight:700;color:var(--text)">${esc(c.name)}</span>
      </div>

      <div style="margin-bottom:10px">
        <label style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">Campaign Keywords</label>
        <input type="text" placeholder="keyword1, keyword2 (matches campaign name)" value="${esc(str(c.campaignKeywords))}" 
          oninput="updateClientField('${esc(c.id)}','campaignKeywords',this.value)"
          style="width:100%;box-sizing:border-box;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);margin-top:3px">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;background:${isOn('enableForward')?'#eff6ff':'var(--card)'}">
          <input type="checkbox" ${isOn('enableForward')?'checked':''} onchange="toggleClientField('${esc(c.id)}','enableForward',this.checked)"> üìß Forward Email
        </label>
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;background:${isOn('enableCalendly')?'#f5f3ff':'var(--card)'}">
          <input type="checkbox" ${isOn('enableCalendly')?'checked':''} onchange="toggleClientField('${esc(c.id)}','enableCalendly',this.checked)"> üìÖ Calendly
        </label>
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;background:${isOn('enableCopyInfo')?'#f0fdf4':'var(--card)'}">
          <input type="checkbox" ${isOn('enableCopyInfo')?'checked':''} onchange="toggleClientField('${esc(c.id)}','enableCopyInfo',this.checked)"> üìã Copy Info
        </label>
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;background:${isOn('enableTracker')?'#fefce8':'var(--card)'}">
          <input type="checkbox" ${isOn('enableTracker')?'checked':''} onchange="toggleClientField('${esc(c.id)}','enableTracker',this.checked)"> üì§ Lead Tracker
        </label>
      </div>

      ${isOn('enableForward')?`<div style="margin-bottom:8px">
        <label style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">Notification Emails</label>
        <input type="text" placeholder="email1@example.com, email2@example.com" value="${esc(str(c.notifyEmails))}" 
          oninput="updateClientField('${esc(c.id)}','notifyEmails',this.value)"
          style="width:100%;box-sizing:border-box;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);margin-top:3px">
      </div>`:''}

      <div style="margin-bottom:8px">
        <label style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">Lead Cost ($)</label>
        <input type="text" placeholder="e.g. 200" value="${esc(str(c.leadCost))}" 
          oninput="updateClientField('${esc(c.id)}','leadCost',this.value)"
          style="width:120px;box-sizing:border-box;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);margin-top:3px">
      </div>

      ${isOn('enableCalendly')?`<div style="margin-bottom:8px">
        <label style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">Calendly URL</label>
        <input type="text" placeholder="https://calendly.com/..." value="${esc(str(c.calendlyUrl))}" 
          oninput="updateClientField('${esc(c.id)}','calendlyUrl',this.value)"
          style="width:100%;box-sizing:border-box;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);margin-top:3px">
      </div>`:''}

    </div>`;
  }

  h+=`<div style="padding:10px 12px;background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.15);border-radius:8px">
    <p style="font-size:11px;color:var(--text-muted);margin:0"><strong style="color:var(--text)">üí° How it works:</strong> Toggle the actions each client needs. Only enabled actions show up on deal cards. Campaign keywords match against Smartlead campaign names to auto-assign leads to clients.</p>
  </div>`;

  h+=`</div>`;
  return h;
}

function updateClientCalendly(name, url){
  const c=state.clients.find(x=>x.name===name);
  if(c) c.calendlyUrl=url;
}

function updateClientField(clientId, field, value){
  const c=state.clients.find(x=>str(x.id)===str(clientId));
  if(c) c[field]=value;
}

function captureClientInputs(){
  const panel=document.querySelector('.settings-body');
  if(!panel) return;
  for(const c of state.clients){
    const id=c.id;
    panel.querySelectorAll('input[type="text"]').forEach(inp=>{
      const handler=inp.getAttribute('oninput')||'';
      const match=handler.match(/updateClientField\('([^']+)','([^']+)'/);
      if(match && match[1]===id){
        c[match[2]]=inp.value;
      }
    });
    panel.querySelectorAll('input[type="checkbox"]').forEach(inp=>{
      const handler=inp.getAttribute('onchange')||'';
      const match=handler.match(/toggleClientField\('([^']+)','([^']+)'/);
      if(match && match[1]===id){
        c[match[2]]=inp.checked?'TRUE':'FALSE';
      }
    });
  }
}

function toggleClientField(clientId, field, checked){
  // Capture ALL current input values before re-rendering so nothing gets lost
  captureClientInputs();
  const c=state.clients.find(x=>str(x.id)===str(clientId));
  if(c){
    c[field]=checked?'TRUE':'FALSE';
  }
  const body=document.querySelector('.settings-body');
  if(body) body.innerHTML=renderClientsSettings();
}

async function saveSettingsToSheet(){
  captureClientInputs();
  applySettings(settingsDraft);
  render();
  const btn=document.querySelector('.settings-footer .btn-primary');
  if(btn){ btn.textContent='Saving...'; btn.disabled=true; }
  try {
    // Build client batch data
    const clientUpdates = state.clients.filter(c=>c.id).map(c=>({
      id:c.id,
      notifyEmails:str(c.notifyEmails),
      campaignKeywords:str(c.campaignKeywords),
      calendlyUrl:str(c.calendlyUrl),
      enableForward:str(c.enableForward),
      enableCalendly:str(c.enableCalendly),
      enableCopyInfo:str(c.enableCopyInfo),
      enableTracker:str(c.enableTracker),
      leadCost:str(c.leadCost)
    }));
    // Fire both in parallel ‚Äî settings + all clients in one batch call
    await Promise.all([
      apiPost('save_settings',{settings:settingsDraft}),
      apiPost('batch_update_clients',{clients:clientUpdates})
    ]);
    if(btn){ btn.textContent='‚úì Saved!'; }
    setTimeout(closeSettings, 800);
  } catch(e){
    if(btn){ btn.textContent='Error ‚Äî Retry'; btn.disabled=false; }
  }
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
let appInitialized=false;
function initApp(){
  if(appInitialized) return;
  appInitialized=true;
  render();
  syncFromSheet();
  setInterval(syncFromSheet, SYNC_INTERVAL);
}
initApp();
</script>
</body>
</html>
